---
title: "Step 2: Delete Card Numbers and CVV"
sidebar_label: "Step 2: Delete Card Numbers"
sidebar_position: 4
description: Remove high-risk cardholder data using Expanso's field deletion operations for PCI-DSS compliance
keywords: [delete-fields, without-operation, card-numbers, cvv-removal, pci-dss-compliance]
---

# Step 2: Delete Card Numbers and CVV

**Master field deletion operations to remove high-risk cardholder data.** This step teaches you to use Expanso's `.without()` function to permanently delete full card numbers, expiry dates, and CVV codes while preserving analytics-safe payment data.

## Learning Objectives

By the end of this step, you'll master:

âœ… **Field deletion syntax** - Using `.without()` to remove specific fields  
âœ… **Multiple field removal** - Deleting several fields in one operation  
âœ… **Structure preservation** - Keeping the remaining data structure intact  
âœ… **Verification techniques** - Confirming complete deletion and testing edge cases  
âœ… **Production deployment** - Creating robust deletion pipelines for real workloads

## Understanding the .without() Operation

Expanso's Bloblang language provides the `.without()` function for removing fields from JSON objects. It creates a new object with specified fields excluded.

### Basic Syntax

```javascript
// Remove single field
result = input.without("field_name")

// Remove multiple fields  
result = input.without("field1", "field2", "field3")

// Remove nested fields
result = input.payment_method.without("full_number", "cvv")
```

### How .without() Works

The `.without()` function:
1. **Creates a copy** of the original object
2. **Excludes specified fields** from the copy
3. **Preserves all other fields** with their original values and types
4. **Maintains structure** of nested objects and arrays

**Important:** `.without()` doesn't modify the original object - it returns a new object without the specified fields.

## Payment Field Deletion Strategy

Based on our field classification from Step 1, we need to delete these high-risk fields:

```json
{
  "payment_method": {
    "full_number": "4532-1234-5678-9010",  // ðŸ”´ Delete - Cardholder data
    "expiry": "12/25",                     // ðŸ”´ Delete - Cardholder data  
    "cvv": "123",                          // ðŸ”´ Delete - Sensitive auth data
    "type": "credit_card",                 // âœ… Keep - Analytics safe
    "brand": "visa",                       // âœ… Keep - Analytics safe
    "last_four": "9010"                    // âœ… Keep - Analytics safe
  }
}
```

**Target:** Remove `full_number`, `expiry`, and `cvv` while keeping `type`, `brand`, and `last_four`.

## Implementation: Delete High-Risk Fields

### Method 1: Single .without() Operation (Recommended)

The most efficient approach removes all high-risk fields in one operation:

```yaml
pipeline:
  processors:
    - mapping: |
        # Copy the entire event
        root = this
        
        # Replace payment_method with cleaned version
        root.payment_method = this.payment_method.without(
          "full_number",
          "expiry", 
          "cvv"
        )
```

**How this works:**
1. `root = this` - Copy entire event structure
2. `this.payment_method.without(...)` - Create cleaned payment_method object  
3. `root.payment_method = ...` - Replace original with cleaned version

**Result:**
```json
{
  "payment_method": {
    "type": "credit_card",    // âœ… Preserved
    "brand": "visa",          // âœ… Preserved
    "last_four": "9010"       // âœ… Preserved
  }
  // All other fields unchanged
}
```

### Method 2: Conditional Deletion

For more complex scenarios, delete fields only if they exist:

```yaml
pipeline:
  processors:
    - mapping: |
        root = this
        
        # Only process if payment_method exists
        if this.payment_method != null {
          root.payment_method = this.payment_method.without(
            "full_number",
            "expiry",
            "cvv"
          )
        }
```

### Method 3: Explicit Field Preservation

If you prefer to explicitly keep certain fields (useful for strict control):

```yaml
pipeline:
  processors:
    - mapping: |
        root = this
        
        # Rebuild payment_method with only safe fields
        if this.payment_method != null {
          root.payment_method = {
            "type": this.payment_method.type,
            "brand": this.payment_method.brand,
            "last_four": this.payment_method.last_four
          }
        }
```

**Trade-offs:**
- âœ… **Explicit control** - You choose exactly what to keep
- âœ… **Future-proof** - New high-risk fields are automatically excluded
- âŒ **More code** - Must list every safe field
- âŒ **Maintenance** - Must update when adding new safe fields

## Complete Pipeline Implementation

Let's create a complete pipeline that deletes payment PII:

Create `delete-card-numbers-pipeline.yaml`:

```yaml
name: delete-card-numbers-pipeline
type: pipeline
config:
  # Accept payment events
  input:
    http_server:
      address: "0.0.0.0:8080"
      path: /events/payment

  pipeline:
    processors:
      # Step 1: Log original event for testing
      - mapping: |
          root = this
          root.processing_stage = "original"
      
      # Step 2: Delete high-risk payment fields
      - mapping: |
          # Copy entire event structure
          root = this
          
          # Remove high-risk payment PII
          root.payment_method = this.payment_method.without(
            "full_number",
            "expiry", 
            "cvv"
          )
          
          # Add processing metadata
          root.pii_removed_at = now().format("2006-01-02T15:04:05Z")
          root.processing_stage = "pii_deleted"

      # Step 3: Validate deletion was successful
      - mapping: |
          root = this
          
          # Check that high-risk fields are gone
          if this.payment_method.full_number != null {
            throw("ERROR: full_number still present after deletion")
          }
          
          if this.payment_method.expiry != null {
            throw("ERROR: expiry still present after deletion") 
          }
          
          if this.payment_method.cvv != null {
            throw("ERROR: cvv still present after deletion")
          }
          
          # Confirm safe fields are preserved
          if this.payment_method.last_four == null {
            throw("ERROR: last_four was deleted accidentally")
          }
          
          root.validation_status = "passed"

  # Output to console for testing (change to analytics later)  
  output:
    stdout:
      codec: lines
```

## Deploy and Test the Pipeline

### Step 1: Deploy the Enhanced Pipeline

```bash
# Navigate to your project directory
cd ~/expanso-payment-pii

# Deploy the new pipeline
expanso job deploy delete-card-numbers-pipeline.yaml

# Verify deployment
expanso job list | grep delete-card-numbers
```

### Step 2: Test with Sample Data

```bash
# Send test payment events
./test-payment-pipeline.sh delete-card-numbers-pipeline sample-payments.json

# Check the processed output
expanso job logs delete-card-numbers-pipeline --tail 20
```

**Expected output:**
```json
{"event_type":"purchase","transaction_id":"txn_001","amount":89.99,"currency":"USD","payment_method":{"type":"credit_card","brand":"visa","last_four":"9010"},"customer":{"id":"cust_456","email":"sarah@example.com"},"pii_removed_at":"2024-12-15T15:45:32Z","processing_stage":"pii_deleted","validation_status":"passed"}
```

**Key observations:**
- âœ… `full_number`, `expiry`, `cvv` are completely gone
- âœ… `type`, `brand`, `last_four` are preserved
- âœ… All other event data unchanged
- âœ… Processing metadata added for audit trail

## Advanced Deletion Techniques

### Handling Nested Payment Structures

Some payment systems use more complex nested structures:

```json
{
  "payment": {
    "card": {
      "number": "4532-1234-5678-9010",     // ðŸ”´ Delete
      "exp": {"month": 12, "year": 2025},   // ðŸ”´ Delete  
      "security_code": "123",               // ðŸ”´ Delete
      "display": {
        "last_four": "9010",                // âœ… Keep
        "brand": "visa"                     // âœ… Keep
      }
    }
  }
}
```

**Pipeline for nested structure:**
```yaml
pipeline:
  processors:
    - mapping: |
        root = this
        
        # Delete from nested card object
        if this.payment.card != null {
          root.payment.card = this.payment.card.without(
            "number", 
            "exp",
            "security_code"
          )
        }
```

### Handling Multiple Payment Methods

For events with multiple payment methods (e.g., split payments):

```json
{
  "payment_methods": [
    {
      "full_number": "4532-1234-5678-9010",  // ðŸ”´ Delete
      "type": "credit_card",                 // âœ… Keep
      "amount": 50.00
    },
    {
      "full_number": "5555-4444-3333-2222",  // ðŸ”´ Delete  
      "type": "credit_card",                 // âœ… Keep
      "amount": 39.99
    }
  ]
}
```

**Pipeline for arrays:**
```yaml
pipeline:
  processors:
    - mapping: |
        root = this
        
        # Process array of payment methods
        root.payment_methods = this.payment_methods.map_each(
          this.without("full_number", "expiry", "cvv")
        )
```

### Field Existence Checking

Before deletion, check if high-risk fields actually exist:

```yaml
pipeline:
  processors:
    - mapping: |
        root = this
        
        # Track what was deleted for audit
        root.deletion_log = {}
        
        if this.payment_method.full_number != null {
          root.deletion_log.full_number_deleted = true
        }
        
        if this.payment_method.cvv != null {
          root.deletion_log.cvv_deleted = true
        }
        
        # Perform deletion
        root.payment_method = this.payment_method.without(
          "full_number", "expiry", "cvv"
        )
```

## Error Handling and Edge Cases

### Handle Missing payment_method Object

```yaml
pipeline:
  processors:
    - mapping: |
        root = this
        
        # Only process events with payment_method
        if this.payment_method == null {
          root.processing_note = "No payment_method found - skipping deletion"
        } else {
          root.payment_method = this.payment_method.without(
            "full_number", "expiry", "cvv"
          )
          root.processing_note = "Payment PII deleted successfully"
        }
```

### Handle Empty payment_method Object

```yaml
pipeline:
  processors:
    - mapping: |
        root = this
        
        if this.payment_method == null || this.payment_method == {} {
          root.processing_note = "Empty payment_method - no deletion needed"
        } else {
          # Count fields before deletion
          original_fields = this.payment_method.keys().length()
          
          # Perform deletion
          root.payment_method = this.payment_method.without(
            "full_number", "expiry", "cvv" 
          )
          
          # Count fields after deletion
          remaining_fields = root.payment_method.keys().length()
          root.deletion_summary = {
            "original_fields": original_fields,
            "remaining_fields": remaining_fields,
            "fields_deleted": original_fields - remaining_fields
          }
        }
```

### Validate Required Safe Fields

Ensure that deletion doesn't accidentally remove fields you need:

```yaml
pipeline:
  processors:
    - mapping: |
        root = this
        
        # Store original safe fields  
        required_fields = {
          "last_four": this.payment_method.last_four,
          "type": this.payment_method.type,
          "brand": this.payment_method.brand
        }
        
        # Perform deletion
        root.payment_method = this.payment_method.without(
          "full_number", "expiry", "cvv"
        )
        
        # Verify required fields still exist
        if root.payment_method.last_four == null && required_fields.last_four != null {
          throw("ERROR: last_four was accidentally deleted")
        }
        
        if root.payment_method.type == null && required_fields.type != null {
          throw("ERROR: payment type was accidentally deleted")  
        }
```

## Testing and Verification

### Create Comprehensive Test Data

Create test cases that cover edge cases:

```bash
# Create edge case test data
cat > edge-case-payments.json << 'EOF'
{
  "event_type": "purchase",
  "payment_method": {
    "full_number": "4532-1234-5678-9010",
    "expiry": "12/25",
    "cvv": "123",
    "type": "credit_card",
    "last_four": "9010"
  }
}
{
  "event_type": "purchase", 
  "payment_method": {
    "type": "debit_card",
    "last_four": "5678"
  }
}
{
  "event_type": "purchase",
  "payment_method": {}
}
{
  "event_type": "purchase"
}
{
  "event_type": "purchase",
  "payment_method": {
    "full_number": null,
    "type": "credit_card",
    "last_four": "1111"
  }
}
EOF
```

### Test Edge Cases

```bash
# Test edge cases
./test-payment-pipeline.sh delete-card-numbers-pipeline edge-case-payments.json

# Examine results
expanso job logs delete-card-numbers-pipeline --tail 30
```

### Create Verification Script

```bash
# Create verification script
cat > verify-deletion.sh << 'EOF'
#!/bin/bash

PIPELINE_NAME="delete-card-numbers-pipeline"

echo "ðŸ” Verifying payment PII deletion..."

# Get recent logs
LOGS=$(expanso job logs $PIPELINE_NAME --tail 10)

# Check for high-risk fields in output
HIGH_RISK_FOUND=$(echo "$LOGS" | grep -E '"full_number"|"expiry"|"cvv"')

if [ -n "$HIGH_RISK_FOUND" ]; then
  echo "âŒ HIGH-RISK FIELDS FOUND IN OUTPUT:"
  echo "$HIGH_RISK_FOUND"
  echo ""
  echo "ðŸš¨ POTENTIAL PCI-DSS COMPLIANCE VIOLATION"
  exit 1
else
  echo "âœ… No high-risk fields found in output"
fi

# Check for required safe fields
SAFE_FIELDS_FOUND=$(echo "$LOGS" | grep -c '"last_four"')
if [ "$SAFE_FIELDS_FOUND" -gt 0 ]; then
  echo "âœ… Safe fields (last_four) preserved: $SAFE_FIELDS_FOUND events"
else
  echo "âš ï¸  No safe fields found - check if events contain payment_method"
fi

echo ""
echo "ðŸŽ¯ Verification complete"
EOF

chmod +x verify-deletion.sh

# Run verification
./verify-deletion.sh
```

## Performance Considerations

### Optimizing Deletion Operations

For high-volume payment processing, optimize your deletion pipeline:

```yaml
# Optimized pipeline for high volume
pipeline:
  processors:
    # Single-pass deletion without validation (for performance)
    - mapping: |
        root = this.without("_temp")  # Remove any temp fields
        
        # Fast payment_method cleaning
        root.payment_method = this.payment_method.without(
          "full_number", "expiry", "cvv", "pin", "cardholder_name"
        ) if this.payment_method != null
        
        # Add minimal processing metadata
        root.processed_at = now().unix()
```

### Memory-Efficient Processing

For large payment events, use selective copying:

```yaml
pipeline:
  processors:
    - mapping: |
        # Copy only needed fields (more memory efficient)
        root = {
          "event_type": this.event_type,
          "transaction_id": this.transaction_id,
          "amount": this.amount,
          "currency": this.currency,
          "timestamp": this.timestamp,
          "merchant": this.merchant,
          "customer": this.customer,
          "payment_method": this.payment_method.without(
            "full_number", "expiry", "cvv"
          ) if this.payment_method != null
        }
```

## Production Deployment Considerations

### Environment-Specific Configuration

```yaml
# Production-ready pipeline
name: delete-payment-pii-prod
type: pipeline
config:
  input:
    http_server:
      address: "0.0.0.0:8080"
      path: /events/payment
      # Production: Enable TLS
      cert_file: "/etc/ssl/certs/payment-pipeline.crt"
      key_file: "/etc/ssl/private/payment-pipeline.key"

  pipeline:
    processors:
      # Production: Add comprehensive logging
      - mapping: |
          root = this
          root.processing_metadata = {
            "pipeline_version": "v1.0.0",
            "node_id": env("NODE_ID"),
            "processing_started_at": now().format("2006-01-02T15:04:05.000Z")
          }

      # High-risk field deletion  
      - mapping: |
          root = this
          
          # Delete payment PII
          root.payment_method = this.payment_method.without(
            "full_number", "expiry", "cvv", "pin", "cardholder_name"
          ) if this.payment_method != null
          
          # Update processing metadata
          root.processing_metadata.pii_deleted_at = now().format("2006-01-02T15:04:05.000Z")
          root.processing_metadata.fields_deleted = ["full_number", "expiry", "cvv"]

  output:
    # Production: Send to analytics system
    http_client:
      url: "${ANALYTICS_ENDPOINT}"
      verb: POST
      headers:
        Authorization: "Bearer ${ANALYTICS_API_KEY}"
        Content-Type: "application/json"
      # Production: Add retry logic
      retry_period: "5s"  
      max_retries: 3
```

## Summary

You've mastered high-risk payment field deletion:

âœ… **Deletion syntax:** Using `.without()` to remove specific fields safely  
âœ… **Multiple field removal:** Deleting full_number, expiry, and cvv in one operation  
âœ… **Structure preservation:** Keeping payment_method structure with safe fields  
âœ… **Error handling:** Managing missing objects and validation failures  
âœ… **Testing:** Verifying complete deletion with comprehensive test cases  
âœ… **Production readiness:** Optimized pipelines for real workloads

**Key Techniques:**
- `.without("field1", "field2", "field3")` for multi-field deletion
- `root.payment_method = this.payment_method.without(...)` for targeted object cleaning  
- Validation checks to ensure deletion succeeded
- Edge case handling for missing or empty payment objects

## Common Pitfalls and Solutions

### Pitfall 1: Incomplete Field Lists
**Problem:** Missing some high-risk fields in `.without()` list
**Solution:** Create comprehensive field inventories, test with real data

### Pitfall 2: Accidental Safe Field Deletion  
**Problem:** Including safe fields like `last_four` in deletion list
**Solution:** Use explicit safe field lists, validate after deletion

### Pitfall 3: Null Object Handling
**Problem:** Pipeline fails when `payment_method` is null
**Solution:** Add null checks before deletion operations

### Pitfall 4: Nested Structure Confusion
**Problem:** Deleting from wrong object level in nested structures
**Solution:** Map your exact data structure, test with realistic data

---

## What's Next

You've successfully deleted high-risk payment fields. Next, you'll learn to preserve analytics-safe payment data and structure it for optimal business intelligence.

<div style={{display: 'flex', gap: '1.5rem', marginTop: '2rem', marginBottom: '3rem', flexWrap: 'wrap', justifyContent: 'flex-start'}}>
  <a href="./step-3-preserve-analytics-data" className="button button--primary button--lg" style={{display: 'inline-flex', alignItems: 'center', justifyContent: 'center', textDecoration: 'none', borderRadius: '8px', padding: '1rem 2rem', fontWeight: '600', minWidth: '240px', boxShadow: '0 2px 8px rgba(0,0,0,0.15)', cursor: 'pointer', transition: 'all 0.2s ease'}}>
    Step 3: Preserve Analytics Data
  </a>
  <a href="./step-1-identify-payment-pii" className="button button--secondary button--lg" style={{display: 'inline-flex', alignItems: 'center', justifyContent: 'center', textDecoration: 'none', borderRadius: '8px', padding: '1rem 2rem', fontWeight: '600', minWidth: '240px', boxShadow: '0 2px 8px rgba(0,0,0,0.15)', cursor: 'pointer', transition: 'all 0.2s ease'}}>
    Back to Step 1
  </a>
</div>

**Next:** [Learn to structure and preserve analytics-safe payment data](./step-3-preserve-analytics-data) for maximum business intelligence value.
