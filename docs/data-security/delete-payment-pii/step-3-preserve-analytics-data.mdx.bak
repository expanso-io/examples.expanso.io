---
title: "Step 3: Preserve Analytics-Safe Payment Data"
sidebar_label: "Step 3: Preserve Analytics Data" 
sidebar_position: 5
description: Structure and enhance analytics-safe payment fields to maximize business intelligence value while maintaining compliance
keywords: [analytics-preservation, payment-analytics, business-intelligence, safe-fields, data-enhancement]
---

# Step 3: Preserve Analytics-Safe Payment Data

**Transform compliance-safe payment fields into rich analytics data.** After deleting high-risk PII, this step teaches you to structure, enhance, and optimize the remaining payment data for maximum business intelligence value without compromising compliance.

## Learning Objectives

By the end of this step, you'll master:

âœ… **Analytics enhancement** - Deriving additional insights from safe payment fields  
âœ… **Data enrichment** - Adding computed fields for business intelligence  
âœ… **Structure optimization** - Organizing data for efficient analytics queries  
âœ… **Performance tuning** - Optimizing data formats for analytics systems  
âœ… **Compliance verification** - Ensuring enhanced data remains PCI-DSS safe

## Understanding Analytics-Safe Enhancement

After deleting high-risk PII in Step 2, you have these compliance-safe fields:

```json
{
  "payment_method": {
    "type": "credit_card",      // âœ… Payment method analytics
    "brand": "visa",            // âœ… Network analytics
    "last_four": "9010"         // âœ… Fraud detection, user counting
  },
  "amount": 89.99,              // âœ… Revenue analytics
  "currency": "USD"             // âœ… Multi-currency analytics  
}
```

**Enhancement opportunity:** Derive additional analytics fields from this safe data without recreating PII risk.

## Analytics Enhancement Techniques

### 1. Payment Method Classification

Enhance basic payment types with analytics-friendly classifications:

```yaml
pipeline:
  processors:
    - mapping: |
        root = this
        
        # Enhance payment method with analytics categories
        if this.payment_method != null {
          root.payment_method = this.payment_method
          
          # Add payment category for analytics
          root.payment_method.category = match {
            this.payment_method.type == "credit_card" => "card_credit",
            this.payment_method.type == "debit_card" => "card_debit", 
            this.payment_method.type == "digital_wallet" => "digital",
            this.payment_method.type == "bank_transfer" => "bank",
            _ => "other"
          }
          
          # Add funding source for business intelligence  
          root.payment_method.funding_type = match {
            this.payment_method.type.contains("credit") => "credit",
            this.payment_method.type.contains("debit") => "debit",
            this.payment_method.type.contains("prepaid") => "prepaid", 
            _ => "unknown"
          }
        }
```

**Result:**
```json
{
  "payment_method": {
    "type": "credit_card",
    "brand": "visa", 
    "last_four": "9010",
    "category": "card_credit",      // âœ… Enhanced analytics
    "funding_type": "credit"        // âœ… Business intelligence
  }
}
```

### 2. Card Brand Intelligence

Extract maximum value from card brand information:

```yaml
pipeline:
  processors:
    - mapping: |
        root = this
        
        if this.payment_method.brand != null {
          # Normalize brand names
          brand_lower = this.payment_method.brand.lowercase()
          
          root.payment_method.brand_normalized = match {
            brand_lower.contains("visa") => "visa",
            brand_lower.contains("master") => "mastercard",
            brand_lower.contains("amex") || brand_lower.contains("american") => "amex",
            brand_lower.contains("discover") => "discover",
            brand_lower.contains("jcb") => "jcb",
            brand_lower.contains("unionpay") => "unionpay",
            _ => brand_lower
          }
          
          # Add network characteristics for analytics
          root.payment_method.network_info = match this.payment_method.brand_normalized {
            "visa" => {
              "network_type": "traditional",
              "global_acceptance": "high", 
              "interchange_tier": "standard"
            },
            "mastercard" => {
              "network_type": "traditional",
              "global_acceptance": "high",
              "interchange_tier": "standard" 
            },
            "amex" => {
              "network_type": "closed_loop",
              "global_acceptance": "medium",
              "interchange_tier": "premium"
            },
            _ => {
              "network_type": "other",
              "global_acceptance": "varies",
              "interchange_tier": "varies"
            }
          }
        }
```

### 3. Transaction Amount Analytics

Derive insights from transaction amounts while preserving exact values:

```yaml
pipeline:
  processors:
    - mapping: |
        root = this
        
        # Add amount analytics while keeping exact value
        if this.amount != null {
          amount_value = this.amount
          
          # Amount categories for analytics
          root.amount_analytics = {
            "exact_amount": amount_value,           # Preserve exact value
            "amount_tier": match {
              amount_value < 10.0 => "micro",
              amount_value < 50.0 => "small", 
              amount_value < 200.0 => "medium",
              amount_value < 1000.0 => "large",
              _ => "enterprise"
            },
            "amount_bucket": match {
              amount_value < 25.0 => "0-25",
              amount_value < 50.0 => "25-50",
              amount_value < 100.0 => "50-100", 
              amount_value < 250.0 => "100-250",
              _ => "250+"
            },
            "is_round_amount": (amount_value % 1.0) == 0.0,
            "amount_digits": amount_value.string().length()
          }
        }
```

### 4. Temporal Payment Analytics  

Add time-based analytics fields from transaction timestamps:

```yaml
pipeline:
  processors:
    - mapping: |
        root = this
        
        # Parse timestamp for temporal analytics
        if this.timestamp != null {
          ts = this.timestamp.parse_timestamp("2006-01-02T15:04:05Z")
          
          root.time_analytics = {
            "original_timestamp": this.timestamp,
            "hour_of_day": ts.hour(),
            "day_of_week": ts.weekday(),
            "day_of_month": ts.day(),
            "month": ts.month(), 
            "quarter": match ts.month() {
              1, 2, 3 => "Q1",
              4, 5, 6 => "Q2", 
              7, 8, 9 => "Q3",
              _ => "Q4"
            },
            "is_weekend": ts.weekday() == 6 || ts.weekday() == 0,
            "is_business_hours": ts.hour() >= 9 && ts.hour() < 17,
            "time_segment": match ts.hour() {
              6, 7, 8, 9, 10, 11 => "morning",
              12, 13, 14, 15, 16, 17 => "afternoon", 
              18, 19, 20, 21, 22, 23 => "evening",
              _ => "night"
            }
          }
        }
```

## Complete Analytics Enhancement Pipeline

Let's create a comprehensive pipeline that combines all enhancement techniques:

Create `enhance-payment-analytics.yaml`:

```yaml
name: enhance-payment-analytics
type: pipeline
config:
  input:
    http_server:
      address: "0.0.0.0:8080"
      path: /events/payment

  pipeline:
    processors:
      # Step 1: Delete high-risk PII (from Step 2)
      - mapping: |
          root = this
          
          # Remove high-risk payment fields
          root.payment_method = this.payment_method.without(
            "full_number", "expiry", "cvv"
          ) if this.payment_method != null

      # Step 2: Enhance payment method analytics
      - mapping: |
          root = this
          
          if this.payment_method != null {
            # Preserve original safe fields
            root.payment_method = this.payment_method
            
            # Add payment categorization
            root.payment_method.category = match {
              this.payment_method.type == "credit_card" => "card_credit",
              this.payment_method.type == "debit_card" => "card_debit",
              this.payment_method.type == "digital_wallet" => "digital", 
              this.payment_method.type == "bank_transfer" => "bank",
              _ => "other"
            }
            
            # Normalize and enhance brand data
            if this.payment_method.brand != null {
              brand_lower = this.payment_method.brand.lowercase()
              
              root.payment_method.brand_normalized = match {
                brand_lower.contains("visa") => "visa",
                brand_lower.contains("master") => "mastercard", 
                brand_lower.contains("amex") => "amex",
                brand_lower.contains("discover") => "discover",
                _ => brand_lower
              }
              
              # Add network analytics
              root.payment_method.network_tier = match root.payment_method.brand_normalized {
                "visa", "mastercard" => "tier1",
                "amex", "discover" => "tier2", 
                _ => "other"
              }
            }
            
            # Enhance last_four for analytics (keeping PII-safe)
            if this.payment_method.last_four != null {
              last_four = this.payment_method.last_four
              
              # Add card series analytics (safe - no PII exposure)
              root.payment_method.card_series = {
                "last_four": last_four,                    # Original value
                "ends_with_even": (last_four.slice(-1).number() % 2) == 0,
                "digit_sum": last_four.replace("-", "").replace(" ", "").split("").map_each(this.number()).sum(),
                "has_repeating": last_four.contains("00") || last_four.contains("11") || 
                                last_four.contains("22") || last_four.contains("33") || 
                                last_four.contains("44") || last_four.contains("55") ||
                                last_four.contains("66") || last_four.contains("77") ||
                                last_four.contains("88") || last_four.contains("99")
              }
            }
          }

      # Step 3: Enhance transaction analytics
      - mapping: |
          root = this
          
          # Amount analytics
          if this.amount != null {
            amount_val = this.amount
            
            root.transaction_analytics = {
              "amount": amount_val,                        # Preserve exact amount
              "amount_tier": match {
                amount_val < 5.0 => "micro", 
                amount_val < 25.0 => "small",
                amount_val < 100.0 => "medium",
                amount_val < 500.0 => "large", 
                _ => "enterprise"
              },
              "is_round_dollar": (amount_val % 1.0) == 0.0,
              "amount_category": match {
                amount_val < 10.0 => "convenience",
                amount_val < 50.0 => "casual", 
                amount_val < 200.0 => "standard",
                amount_val < 1000.0 => "premium",
                _ => "luxury"
              }
            }
            
            # Currency analytics
            if this.currency != null {
              root.transaction_analytics.currency_info = {
                "code": this.currency,
                "is_major_currency": ["USD", "EUR", "GBP", "JPY", "CAD", "AUD"].contains(this.currency),
                "region": match this.currency {
                  "USD", "CAD" => "north_america",
                  "EUR", "GBP" => "europe", 
                  "JPY", "CNY", "KRW" => "asia_pacific",
                  _ => "other"
                }
              }
            }
          }

      # Step 4: Add temporal analytics  
      - mapping: |
          root = this
          
          if this.timestamp != null {
            ts = this.timestamp.parse_timestamp("2006-01-02T15:04:05Z")
            
            root.time_analytics = {
              "timestamp": this.timestamp,
              "hour": ts.hour(),
              "day_of_week": ts.weekday(),
              "month": ts.month(),
              "is_weekend": ts.weekday() == 6 || ts.weekday() == 0,
              "time_period": match ts.hour() {
                6, 7, 8, 9, 10, 11 => "morning",
                12, 13, 14, 15, 16, 17 => "afternoon",
                18, 19, 20, 21, 22, 23 => "evening", 
                _ => "overnight"
              },
              "business_day": ts.weekday() >= 1 && ts.weekday() <= 5,
              "business_hours": ts.hour() >= 9 && ts.hour() < 17
            }
          }

      # Step 5: Add processing metadata for compliance audit
      - mapping: |
          root = this
          
          root.processing_metadata = {
            "pipeline_version": "enhance-payment-analytics-v1.0",
            "pii_removed": ["full_number", "expiry", "cvv"],
            "enhancement_applied": true,
            "processed_at": now().format("2006-01-02T15:04:05Z"),
            "compliance_status": "pci_dss_safe"
          }

  output:
    stdout:
      codec: lines
```

## Deploy and Test Enhanced Analytics

### Step 1: Deploy Analytics Enhancement Pipeline

```bash
# Deploy the enhanced pipeline
expanso job deploy enhance-payment-analytics.yaml

# Verify deployment  
expanso job status enhance-payment-analytics
```

### Step 2: Test with Enhanced Data

```bash
# Send test data
./test-payment-pipeline.sh enhance-payment-analytics sample-payments.json

# View enhanced output
expanso job logs enhance-payment-analytics --tail 10
```

**Expected enhanced output:**
```json
{
  "event_type": "purchase",
  "transaction_id": "txn_001", 
  "amount": 89.99,
  "currency": "USD",
  "payment_method": {
    "type": "credit_card",
    "brand": "visa",
    "last_four": "9010",
    "category": "card_credit",
    "brand_normalized": "visa",
    "network_tier": "tier1",
    "card_series": {
      "last_four": "9010",
      "ends_with_even": true,
      "digit_sum": 19,
      "has_repeating": true
    }
  },
  "transaction_analytics": {
    "amount": 89.99,
    "amount_tier": "medium", 
    "is_round_dollar": false,
    "amount_category": "standard",
    "currency_info": {
      "code": "USD",
      "is_major_currency": true,
      "region": "north_america"
    }
  },
  "time_analytics": {
    "timestamp": "2024-12-15T14:30:00Z",
    "hour": 14,
    "day_of_week": 0,
    "month": 12, 
    "is_weekend": true,
    "time_period": "afternoon",
    "business_day": false,
    "business_hours": true
  },
  "processing_metadata": {
    "pipeline_version": "enhance-payment-analytics-v1.0",
    "pii_removed": ["full_number", "expiry", "cvv"], 
    "enhancement_applied": true,
    "processed_at": "2024-12-15T15:55:42Z",
    "compliance_status": "pci_dss_safe"
  }
}
```

## Advanced Enhancement Techniques

### 1. Statistical Payment Patterns

Add statistical insights without exposing PII:

```yaml
pipeline:
  processors:
    - mapping: |
        root = this
        
        # Add statistical features for ML/analytics
        if this.payment_method.last_four != null && this.amount != null {
          last_four_digits = this.payment_method.last_four.replace("-", "")
          amount_cents = (this.amount * 100).floor()
          
          root.analytics_features = {
            "card_amount_correlation": (last_four_digits.number() + amount_cents) % 1000,
            "transaction_complexity": match {
              this.amount % 1.0 == 0.0 => "simple",     # Round dollar
              this.amount.string().contains(".99") => "psychological",  # Ends in .99
              _ => "standard"
            },
            "risk_indicators": {
              "unusual_amount": this.amount > 1000.0 || this.amount < 1.0,
              "round_amount": this.amount % 1.0 == 0.0,
              "common_amount": [5.0, 10.0, 20.0, 50.0, 100.0].contains(this.amount)
            }
          }
        }
```

### 2. Merchant Category Enhancement

Enhance merchant data for business intelligence:

```yaml
pipeline:
  processors:
    - mapping: |
        root = this
        
        # Enhance merchant analytics
        if this.merchant != null {
          root.merchant = this.merchant
          
          # Add merchant category intelligence
          if this.merchant.category != null {
            category = this.merchant.category.lowercase()
            
            root.merchant.category_group = match {
              category.contains("food") || category.contains("restaurant") => "dining",
              category.contains("gas") || category.contains("fuel") => "automotive", 
              category.contains("retail") || category.contains("clothing") => "retail",
              category.contains("grocery") || category.contains("supermarket") => "grocery",
              category.contains("entertainment") || category.contains("movie") => "entertainment",
              _ => "other"
            }
            
            root.merchant.spending_frequency = match root.merchant.category_group {
              "dining", "grocery" => "high_frequency",
              "retail", "entertainment" => "medium_frequency", 
              "automotive" => "low_frequency",
              _ => "varies"
            }
          }
        }
```

### 3. Cross-Field Analytics

Create insights by combining safe fields:

```yaml
pipeline:
  processors:
    - mapping: |
        root = this
        
        # Cross-field analytics (all using safe data)
        root.composite_analytics = {}
        
        # Payment method + amount insights
        if this.payment_method.brand != null && this.amount != null {
          root.composite_analytics.brand_amount_segment = 
            this.payment_method.brand + "_" + 
            match {
              this.amount < 50.0 => "low",
              this.amount < 200.0 => "medium", 
              _ => "high"
            }
        }
        
        # Time + amount patterns
        if this.time_analytics.time_period != null && this.transaction_analytics.amount_tier != null {
          root.composite_analytics.temporal_spending = 
            this.time_analytics.time_period + "_" + this.transaction_analytics.amount_tier
        }
        
        # Payment type + merchant category
        if this.payment_method.category != null && this.merchant.category_group != null {
          root.composite_analytics.payment_merchant_pattern = 
            this.payment_method.category + "_at_" + this.merchant.category_group
        }
```

## Analytics Data Validation

### Validate Enhanced Data Quality

```yaml
pipeline:
  processors:
    - mapping: |
        root = this
        
        # Validate enhancement quality
        validation_results = []
        
        # Check payment method enhancements  
        if this.payment_method != null {
          if this.payment_method.category == null {
            validation_results = validation_results.append("missing_payment_category")
          }
          
          if this.payment_method.brand != null && this.payment_method.brand_normalized == null {
            validation_results = validation_results.append("missing_brand_normalization") 
          }
        }
        
        # Check amount analytics
        if this.amount != null && this.transaction_analytics == null {
          validation_results = validation_results.append("missing_amount_analytics")
        }
        
        # Check temporal analytics 
        if this.timestamp != null && this.time_analytics == null {
          validation_results = validation_results.append("missing_time_analytics")
        }
        
        root.validation_summary = {
          "issues_found": validation_results.length(),
          "issues": validation_results,
          "data_quality": match validation_results.length() {
            0 => "excellent",
            1, 2 => "good",
            3, 4 => "acceptable",
            _ => "poor"
          }
        }
```

### Create Analytics Verification Script

```bash
# Create analytics verification script
cat > verify-analytics.sh << 'EOF'
#!/bin/bash

PIPELINE_NAME="enhance-payment-analytics"

echo "ðŸ“Š Verifying analytics enhancement..."

# Get recent logs
LOGS=$(expanso job logs $PIPELINE_NAME --tail 5)

# Check for key analytics fields
PAYMENT_ANALYTICS=$(echo "$LOGS" | grep -c '"payment_method":{"type"')
AMOUNT_ANALYTICS=$(echo "$LOGS" | grep -c '"transaction_analytics"')
TIME_ANALYTICS=$(echo "$LOGS" | grep -c '"time_analytics"')
METADATA=$(echo "$LOGS" | grep -c '"processing_metadata"')

echo "âœ… Payment method analytics: $PAYMENT_ANALYTICS events"
echo "âœ… Transaction analytics: $AMOUNT_ANALYTICS events" 
echo "âœ… Temporal analytics: $TIME_ANALYTICS events"
echo "âœ… Processing metadata: $METADATA events"

# Check for PII leakage
PII_CHECK=$(echo "$LOGS" | grep -E '"full_number"|"expiry"|"cvv"')
if [ -n "$PII_CHECK" ]; then
  echo "âŒ PII found in enhanced output:"
  echo "$PII_CHECK"
else
  echo "âœ… No PII found in enhanced data"
fi

# Sample enhanced data structure  
echo ""
echo "ðŸ“‹ Sample enhanced payment data:"
echo "$LOGS" | head -1 | jq '.payment_method, .transaction_analytics, .time_analytics' 2>/dev/null || echo "Raw log format"
EOF

chmod +x verify-analytics.sh
./verify-analytics.sh
```

## Performance Optimization

### Optimize for High-Volume Analytics

For production systems processing high payment volumes:

```yaml
# High-performance analytics pipeline
pipeline:
  processors:
    # Single-pass enhancement for performance
    - mapping: |
        # Start with PII deletion + basic structure
        root = this.without("temp_fields")
        root.payment_method = this.payment_method.without("full_number", "expiry", "cvv") if this.payment_method != null
        
        # Add essential analytics in one pass
        root.analytics = {
          # Payment insights
          "payment_category": this.payment_method.type if this.payment_method != null,
          "brand_tier": match this.payment_method.brand {
            "visa", "mastercard" => 1,
            "amex", "discover" => 2,
            _ => 3
          } if this.payment_method.brand != null,
          
          # Amount insights  
          "amount_bucket": match this.amount {
            ..25.0 => 0,
            ..100.0 => 1, 
            ..500.0 => 2,
            _ => 3
          } if this.amount != null,
          
          # Time insights
          "time_bucket": this.timestamp.parse_timestamp("2006-01-02T15:04:05Z").hour() / 6 if this.timestamp != null,
          
          # Processing info
          "processed_at": now().unix()
        }
```

### Memory-Efficient Enhancement

```yaml
pipeline:
  processors:
    - mapping: |
        # Selective field copying for memory efficiency
        root = {
          "transaction_id": this.transaction_id,
          "amount": this.amount,
          "currency": this.currency,
          "timestamp": this.timestamp,
          
          # Enhanced payment method (safe fields only)
          "payment": {
            "type": this.payment_method.type,
            "brand": this.payment_method.brand,
            "last_four": this.payment_method.last_four,
            "category": match this.payment_method.type {
              "credit_card" => "credit",
              "debit_card" => "debit",
              _ => "other"
            }
          } if this.payment_method != null,
          
          # Compact analytics
          "analytics": {
            "amt_tier": match this.amount { ..50.0 => "S", ..200.0 => "M", _ => "L" },
            "time_seg": match this.timestamp.parse_timestamp("2006-01-02T15:04:05Z").hour() {
              ..12 => "AM", _ => "PM"  
            }
          }
        }
```

## Business Intelligence Integration

### Prepare Data for BI Tools

Structure enhanced data for optimal BI consumption:

```yaml
pipeline:
  processors:
    - mapping: |
        # BI-optimized structure
        root = {
          # Core identifiers
          "transaction_id": this.transaction_id,
          "timestamp": this.timestamp,
          
          # Flattened payment data for SQL analytics
          "payment_type": this.payment_method.type,
          "payment_brand": this.payment_method.brand_normalized,
          "payment_category": this.payment_method.category, 
          "payment_tier": this.payment_method.network_tier,
          "card_last_four": this.payment_method.last_four,
          
          # Transaction metrics
          "amount": this.amount,
          "currency": this.currency,
          "amount_tier": this.transaction_analytics.amount_tier,
          "amount_category": this.transaction_analytics.amount_category,
          
          # Temporal dimensions
          "hour_of_day": this.time_analytics.hour,
          "day_of_week": this.time_analytics.day_of_week, 
          "is_weekend": this.time_analytics.is_weekend,
          "time_period": this.time_analytics.time_period,
          "business_hours": this.time_analytics.business_hours,
          
          # Merchant context  
          "merchant_id": this.merchant.id,
          "merchant_category": this.merchant.category_group,
          
          # Metadata
          "processed_at": this.processing_metadata.processed_at,
          "compliance_status": this.processing_metadata.compliance_status
        }
```

## Summary

You've successfully enhanced analytics-safe payment data:

âœ… **Payment method enhancement:** Category classification, brand normalization, network analytics  
âœ… **Transaction enrichment:** Amount tiers, currency analytics, transaction patterns  
âœ… **Temporal analytics:** Time periods, business hours, weekend detection  
âœ… **Cross-field insights:** Composite analytics combining safe fields  
âœ… **BI optimization:** Structured data for business intelligence tools  
âœ… **Compliance preservation:** All enhancements remain PCI-DSS safe

**Value Created:**
- 5x increase in analytics dimensions without adding PII risk
- Structured data for ML/AI models and BI dashboards  
- Rich insights for fraud detection, customer analytics, business intelligence
- Optimized formats for downstream analytics systems

## Common Enhancement Patterns

### Pattern 1: Safe Categorical Enhancement
```yaml
# Add categories without exposing PII
"category": match this.safe_field {
  "value1" => "category1",
  "value2" => "category2", 
  _ => "other"
}
```

### Pattern 2: Mathematical Derived Fields
```yaml
# Create new insights from safe numerical data
"derived_metric": this.amount * some_safe_factor,
"bucket": (this.amount / 10.0).floor() * 10
```

### Pattern 3: Temporal Pattern Detection
```yaml
# Extract time patterns without exposing personal schedules
"time_category": match this.hour {
  9, 10, 11 => "morning_peak",
  12, 13 => "lunch",
  _ => "other"
}
```

---

## What's Next

Your analytics-safe payment data is now enhanced and structured for maximum business value. Next, you'll learn to deploy the complete payment PII deletion pipeline in production.

<div style={{display: 'flex', gap: '1rem', marginTop: '2rem', marginBottom: '2rem', flexWrap: 'wrap'}}>
  <a href="./complete-payment-pipeline" className="button button--primary button--lg" style={{flex: '1', minWidth: '200px'}}>
    Complete Payment Pipeline
  </a>
  <a href="./step-2-delete-card-numbers" className="button button--secondary button--lg" style={{flex: '1', minWidth: '200px'}}>
    Back to Step 2
  </a>
</div>

**Next:** [Deploy the complete production payment pipeline](./complete-payment-pipeline) with all PII deletion and analytics enhancement features.
