---
title: "Step 1: Define JSON Schema for Data Validation"
sidebar_label: "Step 1: Define JSON Schema"
sidebar_position: 3
description: Create comprehensive JSON Schema with type checking, range validation, and security boundaries
keywords: [json schema, data validation, type checking, security, schema definition]
---

# Step 1: Define JSON Schema for Data Validation

Learn how to create comprehensive JSON Schemas that validate data structure, enforce types, check value ranges, and provide security boundaries against malicious payloads. This step establishes the foundation for all schema validation by defining exactly what constitutes valid sensor data.

## Understanding JSON Schema

JSON Schema is a vocabulary that allows you to annotate and validate JSON documents. It acts as a contract between data producers (IoT devices) and consumers (cloud analytics), ensuring data quality and preventing system failures.

### Schema Validation Levels

**Level 1: Structure Validation**
- Required fields exist
- Object structure matches expected hierarchy
- Arrays contain expected item types

**Level 2: Type Validation**  
- Strings are strings, numbers are numbers
- Nested objects have correct types
- Null values handled appropriately

**Level 3: Value Validation**
- Number ranges (temperature: -50°C to 100°C)
- String formats (ISO 8601 timestamps)
- Pattern matching (sensor IDs, firmware versions)

**Level 4: Security Validation**
- Block additional properties (prevent injection attacks)
- Validate against known patterns
- Enforce security boundaries

## Step 1.1: Create Basic Schema Structure

Start by defining the basic structure for sensor readings:

```bash
# Create schema directory if not exists
mkdir -p /tmp/schemas

# Create initial schema file
cat > /tmp/schemas/sensor-schema-basic.json << 'EOF'
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://example.com/schemas/sensor-reading-basic.json",
  "title": "Basic Sensor Reading",
  "description": "Minimal schema for IoT sensor readings",
  "type": "object",

  "required": [
    "sensor_id",
    "timestamp",
    "readings"
  ],

  "properties": {
    "sensor_id": {
      "type": "string",
      "description": "Unique sensor identifier"
    },
    "timestamp": {
      "type": "string",
      "description": "When reading was taken"
    },
    "readings": {
      "type": "object",
      "description": "Sensor measurements"
    }
  }
}
EOF

echo "Created basic schema structure"
```

### Test Basic Schema

```bash
# Test basic schema with valid data
echo '{
  "sensor_id": "sensor-42",
  "timestamp": "2025-10-20T14:30:00Z",
  "readings": {
    "temperature_celsius": 23.5
  }
}' | jq -e --schema-file /tmp/schemas/sensor-schema-basic.json

# Expected: passes validation
echo "Basic schema test: $?"
```

## Step 1.2: Add Type Validation

Enhance the schema with strict type checking:

```bash
# Create enhanced schema with type validation
cat > /tmp/schemas/sensor-schema-typed.json << 'EOF'
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://example.com/schemas/sensor-reading-typed.json",
  "title": "Typed Sensor Reading",
  "description": "Schema with strict type validation",
  "type": "object",

  "required": [
    "sensor_id",
    "timestamp",
    "location",
    "readings",
    "metadata"
  ],

  "properties": {
    "sensor_id": {
      "type": "string",
      "description": "Unique sensor identifier",
      "minLength": 1,
      "maxLength": 50
    },

    "timestamp": {
      "type": "string",
      "description": "ISO 8601 timestamp when reading was taken",
      "format": "date-time"
    },

    "location": {
      "type": "object",
      "description": "Physical location of the sensor",
      "required": ["building", "floor", "zone"],
      "properties": {
        "building": {
          "type": "string",
          "description": "Building identifier"
        },
        "floor": {
          "type": "integer",
          "description": "Floor number"
        },
        "zone": {
          "type": "string",
          "description": "Zone within the floor"
        }
      }
    },

    "readings": {
      "type": "object",
      "description": "Sensor measurements",
      "required": ["temperature_celsius", "humidity_percent"],
      "properties": {
        "temperature_celsius": {
          "type": "number",
          "description": "Temperature reading in Celsius"
        },
        "humidity_percent": {
          "type": "number",
          "description": "Relative humidity percentage"
        }
      }
    },

    "metadata": {
      "type": "object",
      "description": "Device metadata",
      "required": ["firmware_version", "battery_percent"],
      "properties": {
        "firmware_version": {
          "type": "string",
          "description": "Firmware version of the sensor"
        },
        "battery_percent": {
          "type": "integer",
          "description": "Battery level percentage"
        }
      }
    }
  }
}
EOF
```

### Test Type Validation

```bash
# Test with correct types
echo "Testing typed schema with valid data..."
echo '{
  "sensor_id": "sensor-42",
  "timestamp": "2025-10-20T14:30:00Z",
  "location": {"building": "warehouse-3", "floor": 2, "zone": "A"},
  "readings": {"temperature_celsius": 23.5, "humidity_percent": 45.2},
  "metadata": {"firmware_version": "2.1.0", "battery_percent": 87}
}' | jq -e --schema-file /tmp/schemas/sensor-schema-typed.json

echo "Valid data test result: $?"

# Test with wrong types (should fail)
echo "Testing typed schema with invalid types..."
echo '{
  "sensor_id": "sensor-42",
  "timestamp": "2025-10-20T14:30:00Z",
  "location": {"building": "warehouse-3", "floor": "second floor", "zone": "A"},
  "readings": {"temperature_celsius": "twenty-three", "humidity_percent": 45.2},
  "metadata": {"firmware_version": "2.1.0", "battery_percent": "eighty-seven"}
}' | jq -e --schema-file /tmp/schemas/sensor-schema-typed.json 2>/dev/null

echo "Invalid types test result: $?"
```

**Expected results:**
- Valid data: exit code 0 (passes)
- Invalid types: exit code 1 (fails)

## Step 1.3: Add Range and Format Validation

Add realistic constraints and format validation:

```bash
# Create schema with range and format validation
cat > /tmp/schemas/sensor-schema-validated.json << 'EOF'
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://example.com/schemas/sensor-reading-validated.json",
  "title": "Validated Sensor Reading",
  "description": "Schema with range and format validation",
  "type": "object",

  "required": [
    "sensor_id",
    "timestamp",
    "location",
    "readings",
    "metadata"
  ],

  "properties": {
    "sensor_id": {
      "type": "string",
      "description": "Unique sensor identifier",
      "pattern": "^sensor-[0-9]+$",
      "examples": ["sensor-42", "sensor-100"]
    },

    "timestamp": {
      "type": "string",
      "description": "ISO 8601 timestamp when reading was taken",
      "format": "date-time",
      "examples": ["2025-10-20T14:30:00Z"]
    },

    "location": {
      "type": "object",
      "description": "Physical location of the sensor",
      "required": ["building", "floor", "zone"],
      "properties": {
        "building": {
          "type": "string",
          "description": "Building identifier",
          "pattern": "^warehouse-[0-9]+$",
          "examples": ["warehouse-1", "warehouse-3"]
        },
        "floor": {
          "type": "integer",
          "description": "Floor number",
          "minimum": 1,
          "maximum": 10
        },
        "zone": {
          "type": "string",
          "description": "Zone within the floor",
          "pattern": "^[A-Z]$",
          "examples": ["A", "B", "C"]
        }
      }
    },

    "readings": {
      "type": "object",
      "description": "Sensor measurements",
      "required": ["temperature_celsius", "humidity_percent"],
      "properties": {
        "temperature_celsius": {
          "type": "number",
          "description": "Temperature reading in Celsius",
          "minimum": -50,
          "maximum": 100,
          "examples": [23.5, 18.2, 30.0]
        },
        "humidity_percent": {
          "type": "number",
          "description": "Relative humidity percentage",
          "minimum": 0,
          "maximum": 100,
          "examples": [45.2, 60.0, 33.8]
        }
      }
    },

    "metadata": {
      "type": "object",
      "description": "Device metadata",
      "required": ["firmware_version", "battery_percent"],
      "properties": {
        "firmware_version": {
          "type": "string",
          "description": "Firmware version of the sensor",
          "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$",
          "examples": ["2.1.0", "1.0.5"]
        },
        "battery_percent": {
          "type": "integer",
          "description": "Battery level percentage",
          "minimum": 0,
          "maximum": 100
        }
      }
    }
  }
}
EOF
```

### Test Range Validation

```bash
# Test range validation scenarios
echo "=== Testing Range Validation ==="

# Test 1: Valid ranges
echo "Test 1: Valid ranges"
echo '{
  "sensor_id": "sensor-42",
  "timestamp": "2025-10-20T14:30:00Z",
  "location": {"building": "warehouse-3", "floor": 2, "zone": "A"},
  "readings": {"temperature_celsius": 23.5, "humidity_percent": 45.2},
  "metadata": {"firmware_version": "2.1.0", "battery_percent": 87}
}' | jq -e --schema-file /tmp/schemas/sensor-schema-validated.json >/dev/null 2>&1
echo "Valid ranges result: $?"

# Test 2: Temperature out of range
echo "Test 2: Temperature out of range"
echo '{
  "sensor_id": "sensor-42",
  "timestamp": "2025-10-20T14:30:00Z",
  "location": {"building": "warehouse-3", "floor": 2, "zone": "A"},
  "readings": {"temperature_celsius": -500, "humidity_percent": 45.2},
  "metadata": {"firmware_version": "2.1.0", "battery_percent": 87}
}' | jq -e --schema-file /tmp/schemas/sensor-schema-validated.json >/dev/null 2>&1
echo "Invalid temperature result: $?"

# Test 3: Humidity out of range  
echo "Test 3: Humidity out of range"
echo '{
  "sensor_id": "sensor-42",
  "timestamp": "2025-10-20T14:30:00Z",
  "location": {"building": "warehouse-3", "floor": 2, "zone": "A"},
  "readings": {"temperature_celsius": 23.5, "humidity_percent": 150},
  "metadata": {"firmware_version": "2.1.0", "battery_percent": 87}
}' | jq -e --schema-file /tmp/schemas/sensor-schema-validated.json >/dev/null 2>&1
echo "Invalid humidity result: $?"

# Test 4: Invalid sensor ID pattern
echo "Test 4: Invalid sensor ID pattern"
echo '{
  "sensor_id": "invalid-sensor-name",
  "timestamp": "2025-10-20T14:30:00Z",
  "location": {"building": "warehouse-3", "floor": 2, "zone": "A"},
  "readings": {"temperature_celsius": 23.5, "humidity_percent": 45.2},
  "metadata": {"firmware_version": "2.1.0", "battery_percent": 87}
}' | jq -e --schema-file /tmp/schemas/sensor-schema-validated.json >/dev/null 2>&1
echo "Invalid sensor ID result: $?"

# Test 5: Invalid timestamp format
echo "Test 5: Invalid timestamp format"
echo '{
  "sensor_id": "sensor-42",
  "timestamp": "not-a-timestamp",
  "location": {"building": "warehouse-3", "floor": 2, "zone": "A"},
  "readings": {"temperature_celsius": 23.5, "humidity_percent": 45.2},
  "metadata": {"firmware_version": "2.1.0", "battery_percent": 87}
}' | jq -e --schema-file /tmp/schemas/sensor-schema-validated.json >/dev/null 2>&1
echo "Invalid timestamp result: $?"
```

**Expected results:**
- Test 1 (valid ranges): 0 (passes)
- Test 2 (invalid temperature): 1 (fails)  
- Test 3 (invalid humidity): 1 (fails)
- Test 4 (invalid sensor ID): 1 (fails)
- Test 5 (invalid timestamp): 1 (fails)

## Step 1.4: Add Security Boundaries

Create the final production schema with security protections:

```bash
# Create production schema with security boundaries
cat > /tmp/schemas/sensor-schema-production.json << 'EOF'
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://example.com/schemas/sensor-reading-v1.0.0.json",
  "title": "Production Sensor Reading Schema",
  "description": "Secure schema for IoT sensor temperature and humidity readings",
  "type": "object",

  "required": [
    "sensor_id",
    "timestamp",
    "location",
    "readings",
    "metadata"
  ],

  "properties": {
    "sensor_id": {
      "type": "string",
      "description": "Unique sensor identifier",
      "pattern": "^sensor-[0-9]+$",
      "minLength": 8,
      "maxLength": 20,
      "examples": ["sensor-42", "sensor-100"]
    },

    "timestamp": {
      "type": "string",
      "description": "ISO 8601 timestamp when reading was taken",
      "format": "date-time",
      "examples": ["2025-10-20T14:30:00Z"]
    },

    "location": {
      "type": "object",
      "description": "Physical location of the sensor",
      "required": ["building", "floor", "zone"],
      "properties": {
        "building": {
          "type": "string",
          "description": "Building identifier",
          "pattern": "^warehouse-[0-9]+$",
          "minLength": 11,
          "maxLength": 15
        },
        "floor": {
          "type": "integer",
          "description": "Floor number",
          "minimum": 1,
          "maximum": 10
        },
        "zone": {
          "type": "string",
          "description": "Zone within the floor",
          "pattern": "^[A-Z]$"
        }
      },
      "additionalProperties": false
    },

    "readings": {
      "type": "object",
      "description": "Sensor measurements",
      "required": ["temperature_celsius", "humidity_percent"],
      "properties": {
        "temperature_celsius": {
          "type": "number",
          "description": "Temperature reading in Celsius",
          "minimum": -50,
          "maximum": 100,
          "multipleOf": 0.1,
          "examples": [23.5, 18.2, 30.0]
        },
        "humidity_percent": {
          "type": "number",
          "description": "Relative humidity percentage",
          "minimum": 0,
          "maximum": 100,
          "multipleOf": 0.1,
          "examples": [45.2, 60.0, 33.8]
        }
      },
      "additionalProperties": false
    },

    "metadata": {
      "type": "object",
      "description": "Device metadata",
      "required": ["firmware_version", "battery_percent"],
      "properties": {
        "firmware_version": {
          "type": "string",
          "description": "Firmware version of the sensor",
          "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$",
          "examples": ["2.1.0", "1.0.5"]
        },
        "battery_percent": {
          "type": "integer",
          "description": "Battery level percentage",
          "minimum": 0,
          "maximum": 100
        }
      },
      "additionalProperties": false
    }
  },

  "additionalProperties": false
}
EOF

echo "Created production schema with security boundaries"
```

### Test Security Boundaries

```bash
echo "=== Testing Security Boundaries ==="

# Test 1: Valid message passes
echo "Test 1: Valid message"
echo '{
  "sensor_id": "sensor-42",
  "timestamp": "2025-10-20T14:30:00Z",
  "location": {"building": "warehouse-3", "floor": 2, "zone": "A"},
  "readings": {"temperature_celsius": 23.5, "humidity_percent": 45.2},
  "metadata": {"firmware_version": "2.1.0", "battery_percent": 87}
}' | jq -e --schema-file /tmp/schemas/sensor-schema-production.json >/dev/null 2>&1
echo "Valid message result: $?"

# Test 2: Additional properties blocked
echo "Test 2: Additional properties (potential injection)"
echo '{
  "sensor_id": "sensor-42",
  "timestamp": "2025-10-20T14:30:00Z",
  "location": {"building": "warehouse-3", "floor": 2, "zone": "A"},
  "readings": {"temperature_celsius": 23.5, "humidity_percent": 45.2},
  "metadata": {"firmware_version": "2.1.0", "battery_percent": 87},
  "malicious_payload": {"command": "shutdown"}
}' | jq -e --schema-file /tmp/schemas/sensor-schema-production.json >/dev/null 2>&1
echo "Additional properties result: $?"

# Test 3: Additional properties in nested objects blocked
echo "Test 3: Additional properties in nested objects"
echo '{
  "sensor_id": "sensor-42",
  "timestamp": "2025-10-20T14:30:00Z",
  "location": {"building": "warehouse-3", "floor": 2, "zone": "A", "admin": true},
  "readings": {"temperature_celsius": 23.5, "humidity_percent": 45.2},
  "metadata": {"firmware_version": "2.1.0", "battery_percent": 87}
}' | jq -e --schema-file /tmp/schemas/sensor-schema-production.json >/dev/null 2>&1
echo "Nested additional properties result: $?"

# Test 4: String length limits enforced
echo "Test 4: String length limits"
echo '{
  "sensor_id": "s-1",
  "timestamp": "2025-10-20T14:30:00Z",
  "location": {"building": "warehouse-3", "floor": 2, "zone": "A"},
  "readings": {"temperature_celsius": 23.5, "humidity_percent": 45.2},
  "metadata": {"firmware_version": "2.1.0", "battery_percent": 87}
}' | jq -e --schema-file /tmp/schemas/sensor-schema-production.json >/dev/null 2>&1
echo "Short sensor ID result: $?"

# Test 5: Precision constraints
echo "Test 5: Precision constraints"
echo '{
  "sensor_id": "sensor-42",
  "timestamp": "2025-10-20T14:30:00Z",
  "location": {"building": "warehouse-3", "floor": 2, "zone": "A"},
  "readings": {"temperature_celsius": 23.123456789, "humidity_percent": 45.2},
  "metadata": {"firmware_version": "2.1.0", "battery_percent": 87}
}' | jq -e --schema-file /tmp/schemas/sensor-schema-production.json >/dev/null 2>&1
echo "High precision result: $?"
```

**Expected results:**
- Test 1 (valid message): 0 (passes)
- Test 2 (additional properties): 1 (fails)
- Test 3 (nested additional properties): 1 (fails)  
- Test 4 (short sensor ID): 1 (fails)
- Test 5 (high precision): 1 (fails)

## Step 1.5: Deploy Schema to Edge Nodes

Deploy the production schema to all edge nodes:

```bash
# Copy production schema to edge nodes
for node in edge-sensor-001 edge-sensor-002; do
  echo "Deploying schema to $node..."
  
  # Copy schema file to edge node
  expanso node copy /tmp/schemas/sensor-schema-production.json \
    $node:/etc/expanso/schemas/sensor-schema-v1.0.0.json
  
  # Verify file was copied
  expanso node exec $node -- ls -l /etc/expanso/schemas/sensor-schema-v1.0.0.json
  
  # Verify schema is valid JSON
  expanso node exec $node -- jq empty /etc/expanso/schemas/sensor-schema-v1.0.0.json
  
  if [ $? -eq 0 ]; then
    echo "✅ Schema deployed successfully to $node"
  else
    echo "❌ Schema deployment failed on $node"
  fi
  
  echo ""
done
```

### Verify Schema Deployment

```bash
# Verify schema files are accessible on all edge nodes
echo "=== Verifying Schema Deployment ==="

for node in edge-sensor-001 edge-sensor-002; do
  echo "Checking $node..."
  
  # Check file exists and permissions
  expanso node exec $node -- ls -l /etc/expanso/schemas/sensor-schema-v1.0.0.json
  
  # Validate JSON syntax
  expanso node exec $node -- jq empty /etc/expanso/schemas/sensor-schema-v1.0.0.json
  JSON_VALID=$?
  
  # Check schema validates against meta-schema
  expanso node exec $node -- jq -e '."$schema" == "http://json-schema.org/draft-07/schema#"' /etc/expanso/schemas/sensor-schema-v1.0.0.json >/dev/null 2>&1
  SCHEMA_VALID=$?
  
  if [ $JSON_VALID -eq 0 ] && [ $SCHEMA_VALID -eq 0 ]; then
    echo "✅ Schema valid on $node"
  else
    echo "❌ Schema invalid on $node"
  fi
  
  echo ""
done
```

## Step 1.6: Create Schema Validation Test Suite

Create a comprehensive test suite to validate your schema works correctly:

```bash
# Create test suite directory
mkdir -p /tmp/schema-tests

# Create comprehensive test cases
cat > /tmp/schema-tests/run-schema-tests.sh << 'EOF'
#!/bin/bash

SCHEMA_FILE="/tmp/schemas/sensor-schema-production.json"
TESTS_PASSED=0
TESTS_TOTAL=0

run_test() {
  local test_name="$1"
  local test_data="$2"
  local expected_result="$3"  # 0 = pass, 1 = fail
  
  TESTS_TOTAL=$((TESTS_TOTAL + 1))
  
  echo -n "Test $TESTS_TOTAL: $test_name... "
  
  echo "$test_data" | jq -e --schema-file "$SCHEMA_FILE" >/dev/null 2>&1
  result=$?
  
  if [ $result -eq $expected_result ]; then
    echo "✅ PASS"
    TESTS_PASSED=$((TESTS_PASSED + 1))
  else
    echo "❌ FAIL (expected $expected_result, got $result)"
  fi
}

echo "=== Schema Validation Test Suite ==="
echo "Schema: $SCHEMA_FILE"
echo ""

# Valid test cases (should pass)
run_test "Valid sensor reading" '{
  "sensor_id": "sensor-42",
  "timestamp": "2025-10-20T14:30:00Z",
  "location": {"building": "warehouse-3", "floor": 2, "zone": "A"},
  "readings": {"temperature_celsius": 23.5, "humidity_percent": 45.2},
  "metadata": {"firmware_version": "2.1.0", "battery_percent": 87}
}' 0

run_test "Minimum valid temperature" '{
  "sensor_id": "sensor-42",
  "timestamp": "2025-10-20T14:30:00Z",
  "location": {"building": "warehouse-1", "floor": 1, "zone": "Z"},
  "readings": {"temperature_celsius": -50.0, "humidity_percent": 0.0},
  "metadata": {"firmware_version": "1.0.0", "battery_percent": 0}
}' 0

run_test "Maximum valid temperature" '{
  "sensor_id": "sensor-999",
  "timestamp": "2025-12-31T23:59:59Z",
  "location": {"building": "warehouse-10", "floor": 10, "zone": "A"},
  "readings": {"temperature_celsius": 100.0, "humidity_percent": 100.0},
  "metadata": {"firmware_version": "99.99.99", "battery_percent": 100}
}' 0

# Invalid structure tests (should fail)
run_test "Missing sensor_id" '{
  "timestamp": "2025-10-20T14:30:00Z",
  "location": {"building": "warehouse-3", "floor": 2, "zone": "A"},
  "readings": {"temperature_celsius": 23.5, "humidity_percent": 45.2},
  "metadata": {"firmware_version": "2.1.0", "battery_percent": 87}
}' 1

run_test "Missing timestamp" '{
  "sensor_id": "sensor-42",
  "location": {"building": "warehouse-3", "floor": 2, "zone": "A"},
  "readings": {"temperature_celsius": 23.5, "humidity_percent": 45.2},
  "metadata": {"firmware_version": "2.1.0", "battery_percent": 87}
}' 1

run_test "Missing location" '{
  "sensor_id": "sensor-42",
  "timestamp": "2025-10-20T14:30:00Z",
  "readings": {"temperature_celsius": 23.5, "humidity_percent": 45.2},
  "metadata": {"firmware_version": "2.1.0", "battery_percent": 87}
}' 1

# Invalid type tests (should fail)
run_test "sensor_id as number" '{
  "sensor_id": 42,
  "timestamp": "2025-10-20T14:30:00Z",
  "location": {"building": "warehouse-3", "floor": 2, "zone": "A"},
  "readings": {"temperature_celsius": 23.5, "humidity_percent": 45.2},
  "metadata": {"firmware_version": "2.1.0", "battery_percent": 87}
}' 1

run_test "floor as string" '{
  "sensor_id": "sensor-42",
  "timestamp": "2025-10-20T14:30:00Z",
  "location": {"building": "warehouse-3", "floor": "second", "zone": "A"},
  "readings": {"temperature_celsius": 23.5, "humidity_percent": 45.2},
  "metadata": {"firmware_version": "2.1.0", "battery_percent": 87}
}' 1

run_test "temperature as string" '{
  "sensor_id": "sensor-42",
  "timestamp": "2025-10-20T14:30:00Z",
  "location": {"building": "warehouse-3", "floor": 2, "zone": "A"},
  "readings": {"temperature_celsius": "twenty-three", "humidity_percent": 45.2},
  "metadata": {"firmware_version": "2.1.0", "battery_percent": 87}
}' 1

# Range validation tests (should fail)
run_test "Temperature too low" '{
  "sensor_id": "sensor-42",
  "timestamp": "2025-10-20T14:30:00Z",
  "location": {"building": "warehouse-3", "floor": 2, "zone": "A"},
  "readings": {"temperature_celsius": -500, "humidity_percent": 45.2},
  "metadata": {"firmware_version": "2.1.0", "battery_percent": 87}
}' 1

run_test "Humidity too high" '{
  "sensor_id": "sensor-42",
  "timestamp": "2025-10-20T14:30:00Z",
  "location": {"building": "warehouse-3", "floor": 2, "zone": "A"},
  "readings": {"temperature_celsius": 23.5, "humidity_percent": 150},
  "metadata": {"firmware_version": "2.1.0", "battery_percent": 87}
}' 1

# Format validation tests (should fail)
run_test "Invalid sensor_id pattern" '{
  "sensor_id": "invalid-sensor",
  "timestamp": "2025-10-20T14:30:00Z",
  "location": {"building": "warehouse-3", "floor": 2, "zone": "A"},
  "readings": {"temperature_celsius": 23.5, "humidity_percent": 45.2},
  "metadata": {"firmware_version": "2.1.0", "battery_percent": 87}
}' 1

run_test "Invalid timestamp format" '{
  "sensor_id": "sensor-42",
  "timestamp": "not-a-timestamp",
  "location": {"building": "warehouse-3", "floor": 2, "zone": "A"},
  "readings": {"temperature_celsius": 23.5, "humidity_percent": 45.2},
  "metadata": {"firmware_version": "2.1.0", "battery_percent": 87}
}' 1

# Security tests (should fail)
run_test "Additional root property" '{
  "sensor_id": "sensor-42",
  "timestamp": "2025-10-20T14:30:00Z",
  "location": {"building": "warehouse-3", "floor": 2, "zone": "A"},
  "readings": {"temperature_celsius": 23.5, "humidity_percent": 45.2},
  "metadata": {"firmware_version": "2.1.0", "battery_percent": 87},
  "admin_override": {"command": "shutdown"}
}' 1

run_test "Additional location property" '{
  "sensor_id": "sensor-42",
  "timestamp": "2025-10-20T14:30:00Z",
  "location": {"building": "warehouse-3", "floor": 2, "zone": "A", "admin": true},
  "readings": {"temperature_celsius": 23.5, "humidity_percent": 45.2},
  "metadata": {"firmware_version": "2.1.0", "battery_percent": 87}
}' 1

echo ""
echo "=== Test Results ==="
echo "Tests passed: $TESTS_PASSED / $TESTS_TOTAL"

if [ $TESTS_PASSED -eq $TESTS_TOTAL ]; then
  echo "✅ All tests passed!"
  exit 0
else
  echo "❌ Some tests failed"
  exit 1
fi
EOF

# Make test script executable
chmod +x /tmp/schema-tests/run-schema-tests.sh

# Run the test suite
echo "Running comprehensive schema test suite..."
/tmp/schema-tests/run-schema-tests.sh
```

## Common Schema Validation Patterns

### Pattern 1: Conditional Validation

```json
{
  "if": {
    "properties": {
      "sensor_type": { "const": "outdoor" }
    }
  },
  "then": {
    "properties": {
      "readings": {
        "properties": {
          "temperature_celsius": {
            "minimum": -40,
            "maximum": 60
          }
        }
      }
    }
  },
  "else": {
    "properties": {
      "readings": {
        "properties": {
          "temperature_celsius": {
            "minimum": 10,
            "maximum": 40
          }
        }
      }
    }
  }
}
```

### Pattern 2: Multiple Schema Versions

```json
{
  "oneOf": [
    {
      "$ref": "sensor-schema-v1.0.0.json"
    },
    {
      "$ref": "sensor-schema-v2.0.0.json"
    }
  ]
}
```

### Pattern 3: Dynamic Property Names

```json
{
  "patternProperties": {
    "^sensor_[0-9]+_readings$": {
      "type": "object",
      "properties": {
        "temperature": { "type": "number" }
      }
    }
  }
}
```

## Production Considerations

### Schema Versioning Strategy

```bash
# Create versioned schema directory structure
mkdir -p /etc/expanso/schemas/v1.0.0
mkdir -p /etc/expanso/schemas/v1.1.0
mkdir -p /etc/expanso/schemas/v2.0.0

# Symlink current version
ln -sf /etc/expanso/schemas/v1.0.0/sensor-schema.json \
       /etc/expanso/schemas/sensor-schema-current.json
```

### Schema Documentation

```bash
# Generate schema documentation
cat > /tmp/schemas/SCHEMA_DOCUMENTATION.md << 'EOF'
# Sensor Schema Documentation

## Version: 1.0.0
## Created: 2025-10-20
## Last Modified: 2025-10-20

## Overview
This schema validates IoT sensor readings for temperature and humidity monitoring systems.

## Required Fields
- `sensor_id`: Unique identifier following pattern `sensor-[0-9]+`
- `timestamp`: ISO 8601 formatted timestamp
- `location`: Physical location with building, floor, zone
- `readings`: Temperature (°C) and humidity (%) measurements
- `metadata`: Device firmware version and battery level

## Validation Rules
- Temperature range: -50°C to 100°C
- Humidity range: 0% to 100%
- Floor range: 1 to 10
- Battery range: 0% to 100%

## Security Features
- Additional properties blocked at all levels
- String length limits enforced
- Pattern matching prevents injection attacks

## Changelog
### v1.0.0 (2025-10-20)
- Initial production schema
- Added security boundaries
- Added range validation for all numeric fields
EOF
```

### Schema Testing in CI/CD

```yaml
# .github/workflows/schema-validation.yml
name: Schema Validation Tests

on:
  pull_request:
    paths:
      - 'schemas/**/*.json'

jobs:
  validate-schema:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
      
      - name: Validate schema syntax
        run: |
          for schema in schemas/**/*.json; do
            jq empty "$schema" || exit 1
          done
      
      - name: Run schema test suite
        run: |
          chmod +x scripts/run-schema-tests.sh
          ./scripts/run-schema-tests.sh
```

## Troubleshooting Schema Definition

### Issue: Schema Syntax Errors

```bash
# Validate JSON syntax
jq empty /tmp/schemas/sensor-schema-production.json

# Check for common syntax issues
echo "Checking for common schema issues..."

# Missing commas
grep -n "}" /tmp/schemas/sensor-schema-production.json | head -5

# Trailing commas (JSON doesn't allow them)
grep -n ",\s*}" /tmp/schemas/sensor-schema-production.json

# Invalid property names
grep -n '"\w+[^"]*"' /tmp/schemas/sensor-schema-production.json
```

### Issue: Schema Validation False Positives

```bash
# Test edge cases that should pass
echo "Testing edge case validations..."

# Empty optional arrays
echo '{
  "sensor_id": "sensor-42",
  "timestamp": "2025-10-20T14:30:00Z",
  "location": {"building": "warehouse-3", "floor": 2, "zone": "A"},
  "readings": {"temperature_celsius": 0.0, "humidity_percent": 0.0},
  "metadata": {"firmware_version": "1.0.0", "battery_percent": 0}
}' | jq -e --schema-file /tmp/schemas/sensor-schema-production.json

# Boundary values
echo '{
  "sensor_id": "sensor-999999",
  "timestamp": "2025-10-20T14:30:00.000Z",
  "location": {"building": "warehouse-10", "floor": 1, "zone": "Z"},
  "readings": {"temperature_celsius": -50, "humidity_percent": 100},
  "metadata": {"firmware_version": "999.999.999", "battery_percent": 100}
}' | jq -e --schema-file /tmp/schemas/sensor-schema-production.json
```

### Issue: Performance with Large Schemas

```bash
# Time schema validation performance
time for i in {1..100}; do
  echo '{
    "sensor_id": "sensor-42",
    "timestamp": "2025-10-20T14:30:00Z",
    "location": {"building": "warehouse-3", "floor": 2, "zone": "A"},
    "readings": {"temperature_celsius": 23.5, "humidity_percent": 45.2},
    "metadata": {"firmware_version": "2.1.0", "battery_percent": 87}
  }' | jq -e --schema-file /tmp/schemas/sensor-schema-production.json >/dev/null
done
```

## Summary

You've successfully created a comprehensive JSON Schema that:

✅ **Validates structure** - Ensures all required fields are present
✅ **Enforces types** - Prevents type mismatches that break processing
✅ **Checks ranges** - Validates realistic sensor value boundaries  
✅ **Validates formats** - Ensures timestamps, IDs, and versions match patterns
✅ **Provides security** - Blocks additional properties and injection attacks
✅ **Deployed to edge nodes** - Schema files available for validation processing
✅ **Tested comprehensively** - 15+ test cases verify all validation scenarios

**Schema features implemented:**
- Required field validation for all sensor data components
- Type checking (string, number, integer, object)
- Range validation (temperature: -50°C to 100°C, humidity: 0-100%)
- Format validation (ISO 8601 timestamps, semantic versioning)
- Pattern matching (sensor IDs, building names, zone codes)
- Security boundaries (additionalProperties: false)
- Precision constraints (multipleOf: 0.1 for measurements)

**Next step:** [Configure Schema Validation](./step-2-configure-validation) to integrate this schema into the edge processing pipeline.

## Reference Files Created

- `/tmp/schemas/sensor-schema-basic.json` - Basic structure validation
- `/tmp/schemas/sensor-schema-typed.json` - Type validation
- `/tmp/schemas/sensor-schema-validated.json` - Range and format validation
- `/tmp/schemas/sensor-schema-production.json` - Complete production schema
- `/etc/expanso/schemas/sensor-schema-v1.0.0.json` - Deployed schema on edge nodes
- `/tmp/schema-tests/run-schema-tests.sh` - Comprehensive test suite
