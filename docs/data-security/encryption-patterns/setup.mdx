---
title: Setup Environment for Field-Level Encryption
sidebar_label: Setup
sidebar_position: 3
description: Configure encryption keys, environment variables, and deploy a shell encryption pipeline
keywords: [setup, encryption, environment, configuration, deployment]
---

# Setup Environment for Field-Level Encryption

Before building the comprehensive encryption pipeline, you'll set up encryption keys, environment variables, and deploy a minimal encryption pipeline to verify your setup works correctly.

## Prerequisites

- ‚úÖ Expanso Edge Runtime installed ([Installation Guide](https://docs.expanso.io/installation))
- ‚úÖ OpenSSL installed for key generation
- ‚úÖ Basic familiarity with symmetric encryption (AES-256)
- ‚úÖ Access to a key management system (AWS KMS, HashiCorp Vault, or environment variables)

## Step 1: Generate Encryption Keys

Field-level encryption requires multiple keys for different data sensitivity levels. Generate secure 256-bit keys for each data type.

```bash
# Generate PCI-DSS payment card encryption key (highest security)
CARD_ENCRYPTION_KEY=$(openssl rand -hex 32)
echo "Card key: $CARD_ENCRYPTION_KEY"

# Generate PII encryption key (high security) 
PII_ENCRYPTION_KEY=$(openssl rand -hex 32)
echo "PII key: $PII_ENCRYPTION_KEY"

# Generate address encryption key (medium security)
ADDRESS_ENCRYPTION_KEY=$(openssl rand -hex 32)
echo "Address key: $ADDRESS_ENCRYPTION_KEY"

# Generate temporal data encryption key (medium security)
TEMPORAL_ENCRYPTION_KEY=$(openssl rand -hex 32)
echo "Temporal key: $TEMPORAL_ENCRYPTION_KEY"

# Verify key lengths (should be 64 characters each)
echo "Card key length: ${#CARD_ENCRYPTION_KEY}"
echo "PII key length: ${#PII_ENCRYPTION_KEY}"
echo "Address key length: ${#ADDRESS_ENCRYPTION_KEY}"
echo "Temporal key length: ${#TEMPORAL_ENCRYPTION_KEY}"
```

**Expected output:**
```
Card key: a1b2c3d4e5f6789012345678901234567890abcdef1234567890abcdef123456
PII key: 789012345678901234567890abcdef123456789012345678901234567890abcd
Address key: def123456789012345678901234567890abcdef123456789012345678901234
Temporal key: 567890abcdef123456789012345678901234567890abcdef1234567890abcdef
Card key length: 64
PII key length: 64
Address key length: 64
Temporal key length: 64
```

## Step 2: Configure Environment Variables

Set up environment variables for the encryption keys and operational metadata.

```bash
# Export encryption keys
export CARD_ENCRYPTION_KEY=$CARD_ENCRYPTION_KEY
export PII_ENCRYPTION_KEY=$PII_ENCRYPTION_KEY
export ADDRESS_ENCRYPTION_KEY=$ADDRESS_ENCRYPTION_KEY
export TEMPORAL_ENCRYPTION_KEY=$TEMPORAL_ENCRYPTION_KEY

# Set key version for rotation tracking
export KEY_VERSION="v1_20251115"

# Set node identification for audit trails
export NODE_ID="edge-node-$(hostname)"

# Set service role for authorization (for decryption examples)
export SERVICE_ROLE="encryption-service"

# Verify environment variables are set
echo "Environment configured:"
echo "- CARD_ENCRYPTION_KEY: ${CARD_ENCRYPTION_KEY:0:8}..."
echo "- PII_ENCRYPTION_KEY: ${PII_ENCRYPTION_KEY:0:8}..."
echo "- ADDRESS_ENCRYPTION_KEY: ${ADDRESS_ENCRYPTION_KEY:0:8}..." 
echo "- TEMPORAL_ENCRYPTION_KEY: ${TEMPORAL_ENCRYPTION_KEY:0:8}..."
echo "- KEY_VERSION: $KEY_VERSION"
echo "- NODE_ID: $NODE_ID"
```

## Step 3: Store Keys Securely (Production)

In production, never use environment variables for encryption keys. Use a proper key management service.

### AWS KMS Example

```bash
# Store keys in AWS KMS (production approach)
aws kms create-key \
  --description "Expanso Payment Card Encryption Key" \
  --key-usage ENCRYPT_DECRYPT \
  --key-spec SYMMETRIC_DEFAULT \
  --tags TagKey=Service,TagValue=Expanso TagKey=DataType,TagValue=PaymentCard

# Store key material in Parameter Store
aws ssm put-parameter \
  --name "/expanso/encryption/card-key" \
  --value "$CARD_ENCRYPTION_KEY" \
  --type "SecureString" \
  --description "Payment card encryption key for PCI-DSS compliance"
```

### HashiCorp Vault Example

```bash
# Store keys in Vault (production approach)
vault kv put secret/expanso/encryption \
  card_key="$CARD_ENCRYPTION_KEY" \
  pii_key="$PII_ENCRYPTION_KEY" \
  address_key="$ADDRESS_ENCRYPTION_KEY" \
  temporal_key="$TEMPORAL_ENCRYPTION_KEY" \
  key_version="$KEY_VERSION" \
  created_at="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

# Verify storage
vault kv get secret/expanso/encryption
```

## Step 4: Create Sample Data

Create test data containing various sensitive fields to verify encryption patterns.

```bash
# Create sample payment and customer data
cat > sample-data.json << 'EOF'
{
  "transaction_id": "txn-12345",
  "timestamp": "2025-01-15T10:00:00Z",
  "amount": 49.99,
  "currency": "USD",
  "payment": {
    "card_number": "4532123456789010",
    "cvv": "123",
    "expiry_month": 12,
    "expiry_year": 2028,
    "cardholder_name": "Sarah Johnson",
    "card_brand": "visa"
  },
  "customer": {
    "customer_id": "cust-789",
    "first_name": "Sarah",
    "last_name": "Johnson",
    "email": "sarah.johnson@example.com",
    "phone": "+1-415-555-0123",
    "ssn": "123-45-6789",
    "date_of_birth": "1985-03-15"
  },
  "billing_address": {
    "street": "123 Main St, Apt 4B",
    "city": "San Francisco",
    "state": "CA",
    "zip": "94102-1234",
    "country": "US"
  },
  "shipping_address": {
    "street": "456 Oak Ave",
    "city": "Palo Alto", 
    "state": "CA",
    "zip": "94301-5678",
    "country": "US"
  }
}
EOF

echo "Sample data created. Contents:"
cat sample-data.json | jq '.'
```

## Step 5: Deploy Shell Encryption Pipeline

Before adding comprehensive encryption, deploy a minimal "shell" pipeline that just validates data structure and adds encryption metadata. This verifies your setup works.

Create `shell-encryption-patterns.yaml`:

```yaml title="shell-encryption-patterns.yaml"
input:
  file:
    paths: 
      - "./sample-data.json"
    codec: "auto"

pipeline:
  processors:
    # Validate required fields exist
    - mapping: |
        root = this
        
        # Verify we have the required sensitive fields
        let required_fields = [
          "payment.card_number",
          "customer.email", 
          "customer.ssn",
          "billing_address.street"
        ]
        
        # Check each required field exists
        let missing_fields = required_fields.filter(field -> {
          this.get(field) == null
        })
        
        # Fail if any required fields are missing
        root = if missing_fields.length() > 0 {
          throw("Missing required fields for encryption: " + missing_fields.join(", "))
        } else {
          this
        }

    # Add shell encryption metadata (without actual encryption yet)
    - mapping: |
        root = this
        
        # Add encryption metadata to track what will be encrypted
        root.encryption_metadata = {
          "encryption_ready": true,
          "timestamp": now(),
          "key_version": env("KEY_VERSION").or("unknown"),
          "node_id": env("NODE_ID").or("unknown"),
          "pipeline": "shell-encryption-patterns",
          "fields_to_encrypt": [
            "payment.card_number",
            "payment.cvv", 
            "payment.cardholder_name",
            "customer.email",
            "customer.phone",
            "customer.ssn",
            "customer.date_of_birth",
            "billing_address.street",
            "billing_address.zip",
            "shipping_address.street",
            "shipping_address.zip"
          ]
        }

output:
  file:
    path: "./shell-output.jsonl"
    codec: "lines"

logger:
  level: "INFO"
  add_timestamp: true
```

Deploy the shell pipeline:

```bash
# Deploy to Expanso Edge Runtime
expanso job deploy shell-encryption-patterns.yaml

# Verify deployment
expanso job list

# Check job status
expanso job status shell-encryption-patterns
```

**Expected output:**
```
Job ID: shell-encryption-patterns
Status: Running
Input: file (./sample-data.json)
Output: file (./shell-output.jsonl)
Processors: 2 (validation, metadata)
```

## Step 6: Test Shell Pipeline

Send test data through the shell pipeline to verify setup works correctly.

```bash
# Process the sample data
echo "Processing sample data through shell pipeline..."

# Wait for processing (file input processes immediately)
sleep 3

# Check the output
echo "Shell pipeline output:"
cat shell-output.jsonl | jq '.'
```

**Expected output:** The original data with encryption metadata added:

```json
{
  "transaction_id": "txn-12345",
  "timestamp": "2025-01-15T10:00:00Z",
  "amount": 49.99,
  "currency": "USD",
  "payment": {
    "card_number": "4532123456789010",
    "cvv": "123",
    "expiry_month": 12,
    "expiry_year": 2028,
    "cardholder_name": "Sarah Johnson",
    "card_brand": "visa"
  },
  "customer": {
    "customer_id": "cust-789",
    "first_name": "Sarah",
    "last_name": "Johnson", 
    "email": "sarah.johnson@example.com",
    "phone": "+1-415-555-0123",
    "ssn": "123-45-6789",
    "date_of_birth": "1985-03-15"
  },
  "billing_address": {
    "street": "123 Main St, Apt 4B",
    "city": "San Francisco",
    "state": "CA",
    "zip": "94102-1234",
    "country": "US"
  },
  "shipping_address": {
    "street": "456 Oak Ave",
    "city": "Palo Alto",
    "state": "CA", 
    "zip": "94301-5678",
    "country": "US"
  },
  "encryption_metadata": {
    "encryption_ready": true,
    "timestamp": "2025-01-15T10:05:30.123Z",
    "key_version": "v1_20251115",
    "node_id": "edge-node-myhost",
    "pipeline": "shell-encryption-patterns",
    "fields_to_encrypt": [
      "payment.card_number",
      "payment.cvv",
      "payment.cardholder_name", 
      "customer.email",
      "customer.phone",
      "customer.ssn",
      "customer.date_of_birth",
      "billing_address.street",
      "billing_address.zip",
      "shipping_address.street",
      "shipping_address.zip"
    ]
  }
}
```

:::tip Success!
If you see the encryption metadata with your key version and node ID, your environment is correctly configured!

**Next step:** [Start with payment card encryption](./step-1-encrypt-payment-data) to implement PCI-DSS compliant field-level encryption.
:::

## Step 7: Verify Encryption Functions

Before proceeding, verify that Expanso's encryption functions work with your keys.

```bash
# Test encryption function directly
cat > test-encryption.yaml << 'EOF' 
input:
  generate:
    count: 1
    interval: "1s"
    mapping: |
      root.test_data = "4532123456789010"

pipeline:
  processors:
    - mapping: |
        root = this
        
        # Test AES-256-GCM encryption
        root.encrypted_data = this.test_data.encrypt_aes("gcm", env("CARD_ENCRYPTION_KEY"))
        
        # Test decryption (verify round-trip works)
        root.decrypted_data = root.encrypted_data.decrypt_aes("gcm", env("CARD_ENCRYPTION_KEY"))
        
        # Verify round-trip success
        root.encryption_test = {
          "success": root.decrypted_data == this.test_data,
          "original_length": this.test_data.length(),
          "encrypted_length": root.encrypted_data.length(),
          "format_check": root.encrypted_data.has_prefix("AES256GCM:")
        }

output:
  file:
    path: "./encryption-test.jsonl"
    codec: "lines"
EOF

# Run encryption test
expanso job deploy test-encryption.yaml

# Wait for test completion
sleep 3

# Check results
echo "Encryption test results:"
cat encryption-test.jsonl | jq '.encryption_test'

# Clean up test job
expanso job stop test-encryption
```

**Expected output:**
```json
{
  "success": true,
  "original_length": 16,
  "encrypted_length": 60,
  "format_check": true
}
```

## Step 8: Environment Validation

Run a comprehensive validation of your setup before starting the tutorial.

```bash
# Validation script
cat > validate-setup.sh << 'EOF'
#!/bin/bash

echo "=== Field-Level Encryption Setup Validation ==="

# Check Expanso is installed
if command -v expanso &> /dev/null; then
    echo "‚úÖ Expanso CLI installed: $(expanso version)"
else
    echo "‚ùå Expanso CLI not found"
    exit 1
fi

# Check environment variables
ENV_VARS=("CARD_ENCRYPTION_KEY" "PII_ENCRYPTION_KEY" "ADDRESS_ENCRYPTION_KEY" "TEMPORAL_ENCRYPTION_KEY" "KEY_VERSION" "NODE_ID")

for var in "${ENV_VARS[@]}"; do
    if [ -n "${!var}" ]; then
        if [ "$var" = "KEY_VERSION" ] || [ "$var" = "NODE_ID" ]; then
            echo "‚úÖ $var: ${!var}"
        else
            echo "‚úÖ $var: ${!var:0:8}... (${#!var} chars)"
        fi
    else
        echo "‚ùå $var: not set"
        exit 1
    fi
done

# Validate key lengths
for var in CARD_ENCRYPTION_KEY PII_ENCRYPTION_KEY ADDRESS_ENCRYPTION_KEY TEMPORAL_ENCRYPTION_KEY; do
    if [ ${#!var} -ne 64 ]; then
        echo "‚ùå $var: invalid length ${#!var} (expected 64)"
        exit 1
    fi
done

# Check sample data exists
if [ -f "sample-data.json" ]; then
    echo "‚úÖ Sample data file exists"
    
    # Validate JSON format
    if jq empty sample-data.json 2>/dev/null; then
        echo "‚úÖ Sample data is valid JSON"
    else
        echo "‚ùå Sample data is invalid JSON"
        exit 1
    fi
else
    echo "‚ùå Sample data file missing"
    exit 1
fi

# Check shell pipeline output
if [ -f "shell-output.jsonl" ]; then
    echo "‚úÖ Shell pipeline executed successfully"
    
    # Validate output format
    if jq empty shell-output.jsonl 2>/dev/null; then
        echo "‚úÖ Shell pipeline output is valid JSON"
        
        # Check encryption metadata was added
        if jq '.encryption_metadata.encryption_ready' shell-output.jsonl | grep -q true; then
            echo "‚úÖ Encryption metadata added correctly"
        else
            echo "‚ùå Encryption metadata missing or invalid"
            exit 1
        fi
    else
        echo "‚ùå Shell pipeline output is invalid JSON" 
        exit 1
    fi
else
    echo "‚ùå Shell pipeline did not produce output"
    exit 1
fi

# Check encryption test results
if [ -f "encryption-test.jsonl" ]; then
    echo "‚úÖ Encryption test completed"
    
    # Verify encryption round-trip success
    if jq '.encryption_test.success' encryption-test.jsonl | grep -q true; then
        echo "‚úÖ Encryption round-trip test passed"
    else
        echo "‚ùå Encryption round-trip test failed"
        exit 1
    fi
else
    echo "‚ùå Encryption test did not complete"
    exit 1
fi

echo ""
echo "üéâ Setup validation complete! Your environment is ready for field-level encryption."
echo ""
echo "Next steps:"
echo "1. Start with payment card encryption: ./step-1-encrypt-payment-data"
echo "2. Follow the step-by-step tutorial to build the complete pipeline"
echo "3. Deploy to production with proper key management (AWS KMS/Vault)"
EOF

chmod +x validate-setup.sh
./validate-setup.sh
```

---

**Next:** [Step 1: Encrypt Payment Data](./step-1-encrypt-payment-data) - Implement PCI-DSS compliant credit card encryption
