---
title: Log File Processing
description: Process application logs, filter by severity, and route errors to separate files
sidebar_position: 3
---

import CodeBlock from '@theme/CodeBlock';
import pipelineYaml from '!!raw-loader!../../examples/log-processing/filter-severity.yaml';


# Log File Processing

This example demonstrates processing application logs from files, filtering by severity level, and routing error logs to a dedicated file while sending warnings to stdout. It's useful for monitoring applications and separating critical errors for investigation.

## What This Pipeline Does

1. **Reads** log files from `/var/log/app/*.log`
2. **Parses** JSON log entries
3. **Enriches** with processing metadata
4. **Filters** to only ERROR and WARN levels
5. **Routes** errors to a file, warnings to stdout

## Complete Pipeline

<CodeBlock language="yaml" title="filter-severity.yaml" showLineNumbers>
  {pipelineYaml}
</CodeBlock>

<a
  href="/files/log-processing/filter-severity.yaml"
  download
  className="button button--primary button--lg margin-top--md"
>
  ðŸ“¥ Download Pipeline
</a>

---


## Configuration Breakdown

### Input: File

```yaml
input:
  file:
    paths:
      - /var/log/app/*.log
    codec: lines
```

The `file` input reads all `.log` files in `/var/log/app/`, processing each line individually. The wildcard pattern allows monitoring multiple log files simultaneously.

**See:** [File Input](https://docs.expanso.io/components/inputs/file)

### Processors: Parse, Enrich, Filter

#### 1. Parse JSON and Add Metadata

```yaml
- mapping: |
    root = this

    # Parse JSON logs
    let parsed = this.parse_json()
    root = if parsed.exists() { parsed } else { this }

    # Add processing metadata
    root.processed_at = now()
    root.node_id = env("NODE_ID").or("unknown")
```

This processor:
- Attempts to parse each log line as JSON
- Falls back to the raw string if parsing fails
- Adds `processed_at` timestamp
- Adds `node_id` from environment variable (defaults to "unknown")

#### 2. Filter by Severity

```yaml
- mapping: |
    root = if this.level == "ERROR" || this.level == "WARN" {
      this
    } else {
      deleted()
    }
```

Filters the stream to only ERROR and WARN level logs. The `deleted()` function removes messages from the pipeline entirely - INFO, DEBUG, and other levels are dropped.

**See:** [Bloblang Guide - Filtering](https://docs.expanso.io/guides/bloblang)

### Output: Switch Based on Severity

```yaml
output:
  switch:
    cases:
      - check: this.level == "ERROR"
        output:
          file:
            path: /var/log/expanso/errors.json
            codec: lines

      - output:
          stdout:
            codec: lines
```

The `switch` output routes messages based on conditions:
- **ERROR logs** â†’ Written to `/var/log/expanso/errors.json`
- **All other logs** (WARN) â†’ Sent to stdout

The final case without a `check` acts as a fallback/default.

**See:** [Switch Output](https://docs.expanso.io/components/outputs/switch) | [File Output](https://docs.expanso.io/components/outputs/file) | [Stdout Output](https://docs.expanso.io/components/outputs/stdout)

## Example Input/Output

### Input Log Line (JSON)

```json
{"timestamp":"2024-01-15T10:30:00Z","level":"ERROR","message":"Database connection failed","service":"api","error":"connection timeout"}
```

### Processed Output (errors.json)

```json
{"timestamp":"2024-01-15T10:30:00Z","level":"ERROR","message":"Database connection failed","service":"api","error":"connection timeout","processed_at":"2024-01-15T10:30:01.123Z","node_id":"edge-001"}
```

### Input Log Line (Plain Text)

```
2024-01-15 10:30:00 [WARN] High memory usage detected
```

### Processed Output (stdout)

```
{"timestamp":"2024-01-15 10:30:00 [WARN] High memory usage detected","processed_at":"2024-01-15T10:30:01.456Z","node_id":"edge-001"}
```

Note: Non-JSON logs are preserved as-is in a root string.

## Common Variations

### Parse Common Log Formats (Apache, Nginx, Syslog)

For standard log formats, use the native parsers instead of regex:

#### Apache/Nginx (Common Log Format)

```yaml
pipeline:
  processors:
    # Parse Apache NCSA combined log format
    - grok:
        expressions:
          - '%{COMMONAPACHELOG}'
```

#### Syslog

```yaml
pipeline:
  processors:
    # Parse syslog RFC3164 or RFC5424
    - parse_log:
        format: syslog_rfc5424
```

These native parsers are faster and more reliable than regex patterns. The `grok` processor includes [default patterns](https://github.com/Jeffail/grok/blob/master/patterns.go#L5) for many common formats including Apache/Nginx logs.

**See:** [Grok Processor](https://docs.expanso.io/components/processors/grok) | [Parse Log Processor](https://docs.expanso.io/components/processors/parse_log)

### Parse Custom Structured Text Logs

For non-standard text logs with a consistent format, use regex or grok:

```yaml
pipeline:
  processors:
    - mapping: |
        # Parse custom format: "2024-01-15 10:30:00 [ERROR] message here"
        let parts = this.re_find_all("(\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2}) \\[([A-Z]+)\\] (.+)")

        root.timestamp = parts.0.1
        root.level = parts.0.2
        root.message = parts.0.3
        root.processed_at = now()
```

### Add Sampling for High-Volume Logs

Keep only 10% of INFO logs to reduce volume:

```yaml
pipeline:
  processors:
    - mapping: |
        root = this.parse_json()
        root.processed_at = now()

    # Sample INFO logs at 10%, keep all errors/warnings
    - mapping: |
        root = if this.level == "INFO" && random_int() % 10 != 0 {
          deleted()
        } else if this.level == "ERROR" || this.level == "WARN" {
          this
        } else {
          deleted()
        }
```

### Extract Stack Traces

Parse and structure stack traces from error logs:

```yaml
pipeline:
  processors:
    - mapping: |
        root = this.parse_json()

        # Extract stack trace lines
        root.stack_trace = if this.error.contains("\n") {
          this.error.split("\n")
        }
```

### Multi-Level Routing

Route to different files based on severity:

```yaml
output:
  switch:
    cases:
      - check: this.level == "ERROR"
        output:
          file:
            path: /var/log/expanso/errors-${!timestamp_unix()}.json
            codec: lines

      - check: this.level == "WARN"
        output:
          file:
            path: /var/log/expanso/warnings-${!timestamp_unix()}.json
            codec: lines

      - check: this.level == "INFO"
        output:
          file:
            path: /var/log/expanso/info-${!timestamp_unix()}.json
            codec: lines

      - output:
          drop: {}
```

### Add Alert Output for Critical Errors

Send critical errors to an HTTP endpoint:

```yaml
output:
  broker:
    pattern: fan_out
    outputs:
      # Always write to file
      - switch:
          cases:
            - check: this.level == "ERROR"
              output:
                file:
                  path: /var/log/expanso/errors.json

      # Send critical errors to alerting system
      - switch:
          cases:
            - check: this.level == "ERROR" && this.message.contains("CRITICAL")
              output:
                http_client:
                  url: http://alerts.example.com/webhook
                  verb: POST
```

## Next Steps

- **[File Input](https://docs.expanso.io/components/inputs/file)** - Complete file input configuration
- **[Switch Output](https://docs.expanso.io/components/outputs/switch)** - Conditional routing patterns
- **[Bloblang Guide](https://docs.expanso.io/guides/bloblang)** - Filtering and transformation reference
- **[Grok Patterns](https://docs.expanso.io/guides/grok-patterns)** - Parse common log formats
