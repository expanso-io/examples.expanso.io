# Complete Payment PII Deletion Pipeline
# Removes credit card numbers, expiry dates, and CVV codes while preserving analytics-safe data
# Achieves PCI-DSS compliance by processing payment data at the edge

name: delete-payment-pii-complete
type: pipeline
config:
  # HTTP input for payment events
  input:
    http_server:
      address: "0.0.0.0:8080"
      path: /events/payment
      # Production TLS configuration
      tls:
        enabled: true
        cert_file: "/etc/ssl/certs/payment-pipeline.crt"
        key_file: "/etc/ssl/private/payment-pipeline.key"
      # Rate limiting and security
      rate_limit: "1000/s"
      max_request_size: 1048576  # 1MB
      timeout: "30s"

  pipeline:
    processors:
      # Stage 1: Input validation and audit preparation
      - mapping: |
          # Validate required fields
          if this.event_type == null {
            throw("Missing required field: event_type")
          }
          
          if this.transaction_id == null {
            throw("Missing required field: transaction_id")
          }
          
          # Initialize processing metadata
          root = this
          root.processing_metadata = {
            "pipeline_version": "v1.0.0",
            "node_id": env("NODE_ID"),
            "processing_started_at": now().format("2006-01-02T15:04:05.000Z"),
            "original_size_bytes": content().length()
          }
          
          # Create pre-deletion audit trail
          if this.payment_method != null {
            high_risk_fields = ["full_number", "expiry", "cvv", "pin", "cardholder_name"]
            safe_fields = ["type", "brand", "last_four", "network"]
            
            root.processing_metadata.audit_trail = {
              "original_fields": this.payment_method.keys(),
              "high_risk_fields_present": high_risk_fields.filter(field => this.payment_method.get(field) != null),
              "safe_fields_present": safe_fields.filter(field => this.payment_method.get(field) != null)
            }
          }

      # Stage 2: High-risk PII deletion
      - mapping: |
          root = this
          
          # Comprehensive deletion of high-risk payment PII
          if this.payment_method != null {
            root.payment_method = this.payment_method.without(
              # Primary Account Number variations
              "full_number",
              "pan", 
              "primary_account_number",
              "card_number",
              "number",
              "cardNumber",
              "fullNumber",
              
              # Expiry date variations
              "expiry",
              "expiry_date", 
              "exp_date",
              "expiration",
              "exp_month",
              "exp_year",
              "expiryDate",
              "expMonth",
              "expYear",
              
              # Security code variations
              "cvv",
              "cvc", 
              "security_code",
              "verification_code",
              "cvv2",
              "securityCode",
              
              # Additional sensitive fields
              "pin",
              "cardholder_name",
              "holder_name", 
              "name_on_card",
              "cardholderName"
            )
          }
          
          # Log deletion results
          root.processing_metadata.pii_deletion = {
            "deleted_at": now().format("2006-01-02T15:04:05.000Z"),
            "fields_deleted": root.processing_metadata.audit_trail.high_risk_fields_present,
            "deletion_method": "bloblang_without_operation"
          }

      # Stage 3: Post-deletion validation
      - mapping: |
          root = this
          
          # Validate that high-risk fields are completely removed
          validation_errors = []
          
          if this.payment_method != null {
            high_risk_fields = ["full_number", "pan", "expiry", "cvv", "cvc", "pin", "cardholder_name"]
            for field in high_risk_fields {
              if this.payment_method.get(field) != null {
                validation_errors = validation_errors.append("High-risk field still present: " + field)
              }
            }
          }
          
          # Check that safe fields are preserved
          if this.processing_metadata.audit_trail.safe_fields_present.contains("last_four") &&
             this.payment_method.last_four == null {
            validation_errors = validation_errors.append("Required safe field deleted: last_four")
          }
          
          if validation_errors.length() > 0 {
            root.processing_metadata.validation_status = "FAILED"
            root.processing_metadata.validation_errors = validation_errors
            throw("PII deletion validation failed: " + validation_errors.join("; "))
          } else {
            root.processing_metadata.validation_status = "PASSED"
          }

      # Stage 4: Analytics enhancement of safe fields
      - mapping: |
          root = this
          
          # Enhance payment method analytics (using only safe fields)
          if this.payment_method != null {
            root.payment_method.analytics = {}
            
            # Payment categorization
            if this.payment_method.type != null {
              root.payment_method.analytics.category = match {
                this.payment_method.type == "credit_card" => "card_credit",
                this.payment_method.type == "debit_card" => "card_debit",
                this.payment_method.type.contains("digital") => "digital_wallet",
                this.payment_method.type.contains("bank") => "bank_transfer",
                _ => "other"
              }
            }
            
            # Brand normalization
            if this.payment_method.brand != null {
              brand_lower = this.payment_method.brand.lowercase()
              root.payment_method.analytics.brand_normalized = match {
                brand_lower.contains("visa") => "visa",
                brand_lower.contains("master") => "mastercard",
                brand_lower.contains("amex") => "amex",
                brand_lower.contains("discover") => "discover",
                _ => brand_lower
              }
              
              # Network tier classification
              root.payment_method.analytics.network_tier = match root.payment_method.analytics.brand_normalized {
                "visa", "mastercard" => "tier1",
                "amex", "discover" => "tier2",
                _ => "other"
              }
            }
          }
          
          # Transaction analytics
          if this.amount != null {
            root.transaction_analytics = {
              "amount": this.amount,
              "amount_tier": match {
                this.amount < 10.0 => "micro",
                this.amount < 50.0 => "small", 
                this.amount < 200.0 => "medium",
                this.amount < 1000.0 => "large",
                _ => "enterprise"
              },
              "is_round_amount": (this.amount % 1.0) == 0.0
            }
            
            # Currency analytics
            if this.currency != null {
              root.transaction_analytics.currency_info = {
                "code": this.currency,
                "is_major_currency": ["USD", "EUR", "GBP", "JPY", "CAD"].contains(this.currency),
                "region": match this.currency {
                  "USD", "CAD" => "north_america",
                  "EUR", "GBP" => "europe",
                  "JPY", "CNY", "KRW" => "asia_pacific",
                  _ => "other"
                }
              }
            }
          }
          
          # Temporal analytics
          if this.timestamp != null {
            ts = this.timestamp.parse_timestamp("2006-01-02T15:04:05Z")
            root.time_analytics = {
              "hour_of_day": ts.hour(),
              "day_of_week": ts.weekday(),
              "is_weekend": ts.weekday() == 6 || ts.weekday() == 0,
              "time_period": match ts.hour() {
                6, 7, 8, 9, 10, 11 => "morning",
                12, 13, 14, 15, 16, 17 => "afternoon",
                18, 19, 20, 21, 22, 23 => "evening",
                _ => "overnight"
              },
              "business_hours": ts.hour() >= 9 && ts.hour() < 17 && ts.weekday() >= 1 && ts.weekday() <= 5
            }
          }

      # Stage 5: Final compliance verification
      - mapping: |
          root = this
          
          # Comprehensive PCI-DSS compliance check
          compliance_check = {
            "pci_dss_compliant": true,
            "violations": [],
            "safe_for_storage": true,
            "safe_for_analytics": true
          }
          
          # Scan entire event for PCI-DSS violation patterns
          event_string = content()
          pii_patterns = [
            '"full_number"',
            '"pan"', 
            '"expiry"',
            '"cvv"',
            '"cvc"',
            '"pin"',
            '"cardholder_name"'
          ]
          
          for pattern in pii_patterns {
            if event_string.contains(pattern) {
              compliance_check.violations = compliance_check.violations.append("Found PCI pattern: " + pattern)
              compliance_check.pci_dss_compliant = false
              compliance_check.safe_for_storage = false
            }
          }
          
          # Add final processing metadata
          root.processing_metadata.compliance_check = compliance_check
          root.processing_metadata.processing_completed_at = now().format("2006-01-02T15:04:05.000Z")
          root.processing_metadata.performance = {
            "processing_duration_ms": (now().unix_nano() - 
              root.processing_metadata.processing_started_at.parse_timestamp("2006-01-02T15:04:05.000Z").unix_nano()) / 1000000,
            "size_reduction_bytes": root.processing_metadata.original_size_bytes - content().length(),
            "fields_removed_count": root.processing_metadata.audit_trail.high_risk_fields_present.length()
          }
          
          # Fail if compliance violations detected
          if !compliance_check.pci_dss_compliant {
            throw("PCI-DSS compliance violations: " + compliance_check.violations.join("; "))
          }

  # Production output configuration
  output:
    broker:
      outputs:
        # Primary output: Analytics system (PCI-safe data)
        - label: "analytics"
          http_client:
            url: "${ANALYTICS_ENDPOINT}"
            verb: POST
            headers:
              Authorization: "Bearer ${ANALYTICS_API_KEY}"
              Content-Type: "application/json"
              X-Pipeline-Version: "delete-payment-pii-v1.0"
            retry_period: "5s"
            max_retries: 3
            timeout: "10s"

        # Secondary output: Compliance audit trail
        - label: "audit"
          file:
            path: "/var/log/expanso/payment-pii-audit.log"
            codec: lines
          processors:
            - mapping: |
                # Create compliance audit record
                root = {
                  "audit_timestamp": this.processing_metadata.processing_completed_at,
                  "transaction_id": this.transaction_id,
                  "fields_deleted": this.processing_metadata.pii_deletion.fields_deleted,
                  "compliance_status": this.processing_metadata.compliance_check.pci_dss_compliant,
                  "processing_duration_ms": this.processing_metadata.performance.processing_duration_ms,
                  "pipeline_version": this.processing_metadata.pipeline_version
                }

        # Error output: Failed processing events
        - label: "errors"
          condition: 'this.processing_metadata.validation_status == "FAILED"'
          file:
            path: "/var/log/expanso/payment-pii-errors.log"
            codec: lines

  # Performance and monitoring configuration
  buffer:
    type: "memory"
    memory:
      limit: "1GB"
      batch_policy:
        count: 1000
        period: "5s"

  # Health check and metrics
  http:
    enabled: true
    address: "0.0.0.0:4195"
    metrics_path: "/metrics"

  # Production logging
  logger:
    level: INFO
    format: json
    static_fields:
      service: "payment-pii-deletion"
      compliance_scope: "pci-dss"
